<!DOCTYPE html>
<html lang="da">
<head>
<!-- PWA Manifest - Inline Base64 -->
<link rel="manifest" href="manifest.json">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=3.0">
    <title>Fitness Journal</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAgCAIAAABywqTfAAABAGlDQ1BpY2MAABiVY2BgPMEABCwGDAy5eSVFQe5OChGRUQrsDxgYgRAMEpOLCxhwA6Cqb9cgai/r4lGHC3CmpBYnA+kPQKxSBLQcaKQIkC2SDmFrgNhJELYNiF1eUlACZAeA2EUhQc5AdgqQrZGOxE5CYicXFIHU9wDZNrk5pckIdzPwpOaFBgNpDiCWYShmCGJwZ3AC+R+iJH8RA4PFVwYG5gkIsaSZDAzbWxkYJG4hxFQWMDDwtzAwbDuPEEOESUFiUSJYiAWImdLSGBg+LWdg4I1kYBC+wMDAFQ0LCBxuUwC7zZ0hHwjTGXIYUoEingx5DMkMekCWEYMBgyGDGQCm1j8/yRb+6wAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJTUUH6gEUCAcUwphoPgAABXNJREFUOMutlV1sW+UZx//Pe46/zrGd2onz1cT5pCFpAoV2LQ2IpqBSoCIV3Q0T08YEbOu4QbANaVygaRdjmoQEaNoEEiCENqRc0FZVydq06qqqhdKUtCYlNGncum5sJ3H8Eef42D7nfXbhFFiZxkX36L153vf5vXpu/v8/SSlxCyVuBf4/8Or/eGPm/2gBAHSjJSLwt/ibpquzDPp6SQEwEUtJADMzQEQqMxMRM4OIAQKIQJKZQQyGJGYmKpUrqaJU2Q5pTuFxEbMAmFmtwkRk21IBAFiWZSrCJDIsK1mxo0ZlfsmYtPTpFBoczl/kz7cemdTuDNf9bEgloTKzECIeT7s1R1JXEpmc5tX8sZQrPrcQqr0i1J6PPh5S6UzXhrGOjZG8Ojoef7I9NHNqctsTgw7dowohsjnjzLmZhbxxcikz/MsH/Kcmuj4c0Tye1oamnuupusy8TCSGjxz+9OHnkv27Zpcz03e3RET7Tt1j21IAeH/kxL6TMZ/TvfP2Fo/To40c0P45Zh0/rtw1ENCdlUKhHE+Yl680ZlJUsIebR7eu/GpLcAEA2BYA7uhty1aov7/FWC6XCsWooi9mi9Z9964sZoqqUvrpT4enn7449HB001AwObWxLxBqarurvwEAEQQAl1PYKysH/3VpOZFfL4V377Mndv84owfw8TGjtTM/PpV99e1/XLUvtnX7y9G2ej2echiebgAMoQJoCvlXLNnTG747rJsZ87kullN7dh36+csbU5ed7hZz4uKhpoErr/2eKgiL61rAvBC1xFp/B8AMASAY9Pc06mfHL//xL6PziWwzxK7hwYGz+y689Mr4vpMHfXXmvtcHGlS2CgNr5sALsaz/yyU3AAapABwKZQolJaS/9acnF5cthe3p+PI7J4zeXY+ve2KHWetUdSVllIOOSn8ggaXrNfUPJlUXYAkhVNu2Pbq2fVPbzFzh13/4KBDQe3o7j2V94XrX8y8e/eDVbc9uqP8sl6+tc5bjMx3eRC6VResGp4cMw9Y0Ra0qIpVKj100D/350bUN/lfenfjbyPn1ruRzO4LddTy7VHr97+nHNoceKiVr1UvJebt+oC9jWYsFhDUSVV3tfmTT5g599Oj5vb99r7vR7cbyF1+ahUpl8qur+y9V1vXWvPzGqXORnEPbG128f11bq9fB8ZwFQJXMCjAXTx49G9u2pevFZzrb2xu8wnXodG5jn/tgJHVi//iefrywXWHb+9nnqlz3TEe970Iqd3nJGgRURQgAg1t6h04nVSFHj0/e8wM5vFPcds9kt/ehrxbL6bHIsdkZe3PTD4e3np3IPrV9EyDbg+79sRzAalX1hmHOxVKf+Nxbw8FPFg5MRA+UDFew+cHf7emsFJbi132bB1u3D/Y9MtQvmSrF0rVLsUjMCUAlAsC1QX9XeyhQ5+/oCrxx9PAWuyiENJvTzY1Nb/7m/nJZFoulq9G5RCI9v5ArrxSnTXeq3GbkTRUAS2ah1Dh5KnJtLRmdxlBs9tz6sD8+u2yI2WvJ+XzeTOfLOZMyZTVdduRl8ErZ9WiHqfldq/4lJauKOJ2ip1pDL/Xtjszem52zTkfNeG4qbajpojAsB5PicYl6n3J7g/NHYe+OwbWAINu2iahoWtPR7PN/PXPui2t3hBSh1xhSJVLX+NyNaxztjVpXs7ezyddSr9cGPF7dKZyqZAbzKi8lZ5crkankyNh0RYrOZl97kzfc6G0IajU+l8ftVB0KEZGAIAIBYAKIiKSUVf8Dw2awLW2bhUJViwYgCLR66CabpqptEq3eEoEZBPAqSwAYjJudvfoVANDX+fdf/P8m5tvp8d38ubHeN4FCoO8C35Nf9A3wfeiNULql+jfEU5ZQODJttQAAAB50RVh0aWNjOmNvcHlyaWdodABHb29nbGUgSW5jLiAyMDE2rAszOAAAABR0RVh0aWNjOmRlc2NyaXB0aW9uAHNSR0K6kHMHAAAAAElFTkSuQmCC">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fitness Tracker">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0F0F0F">
    <meta name="description" content="Din personlige fitness tracker med tr√¶ning, kostplan og progression">
    
    <!-- Apple Touch Icon (180x180 for iOS) -->
    <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=view&id=1O9R78krMnRCBqIb48pxGaBp8oUFksZal">
    
    <!-- Android Chrome Icon (192x192) -->
    <link rel="icon" sizes="192x192" href="https://drive.google.com/uc?export=view&id=1O9R78krMnRCBqIb48pxGaBp8oUFksZal">
    
    <!-- Larger icon for high-res displays -->
    <link rel="icon" sizes="512x512" href="https://drive.google.com/uc?export=view&id=1O9R78krMnRCBqIb48pxGaBp8oUFksZal">
    
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FF3939;
            --secondary: #FFA500;
            --bg-dark: #0F0F0F;
            --bg-card: #1A1A1A;
            --text: #FFFFFF;
            --text-dim: #888888;
            --success: #00FF88;
            --border: #2A2A2A;
            --accent: #E5E5E5;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: #0F0F0F;
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(26, 26, 26, 0.5);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(42, 42, 42, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .header {
            text-align: center;
            padding: 40px 20px;
        }

        .header h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(3rem, 8vw, 6rem);
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
            font-size: 1.2rem;
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .card {
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(42, 42, 42, 0.6);
            margin-bottom: 20px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 0.05em;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .day-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .day-btn {
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-dim);
            cursor: pointer;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 0.05em;
            transition: all 0.3s;
        }

        .day-btn:hover {
            background: rgba(255, 57, 57, 0.1);
            border-color: var(--primary);
        }

        .day-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 57, 57, 0.4);
        }

        .item-list {
            list-style: none;
        }

        .item {
            background: rgba(255, 165, 0, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .item:hover {
            background: rgba(255, 165, 0, 0.1);
            transform: translateX(4px);
        }

        .item.completed {
            opacity: 0.5;
            border-left-color: var(--success);
        }

        .checkbox {
            width: 30px;
            height: 30px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .checkbox.checked::after {
            content: '‚úì';
            color: var(--bg-dark);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: rgba(255, 57, 57, 0.05);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-box .value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: var(--primary);
        }

        .stat-box .label {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .add-form {
            background: rgba(255, 165, 0, 0.05);
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px dashed var(--border);
        }

        .add-form h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
        }

        .form-group select {
            width: 100%;
            padding: 10px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            cursor: pointer;
        }

        .btn-add {
            width: 100%;
            padding: 12px;
            background: var(--secondary);
            border: none;
            border-radius: 8px;
            color: var(--bg-dark);
            font-weight: 700;
            cursor: pointer;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
        }

        .delete-btn {
            background: rgba(255, 57, 57, 0.2);
            border: none;
            color: var(--primary);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 57, 57, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            transition: width 0.5s ease;
        }

        .mini-card {
            background: rgba(255, 165, 0, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 3px solid var(--secondary);
            transition: all 0.3s;
        }

        .mini-card:hover {
            background: rgba(255, 165, 0, 0.1);
        }

        .mini-card.completed {
            opacity: 0.5;
        }

        .overview-section {
            margin-top: 30px;
        }

        .overview-section h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-top: 15px;
        }

        .input-row input {
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text);
        }

        .btn-small {
            padding: 12px 20px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: var(--text);
            font-weight: 700;
            cursor: pointer;
        }

        .edit-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(255, 165, 0, 0.1);
            border: 2px solid var(--secondary);
            border-radius: 8px;
            color: var(--secondary);
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .edit-toggle:hover {
            background: var(--secondary);
            color: var(--bg-dark);
        }

        .edit-toggle.active {
            background: var(--secondary);
            color: var(--bg-dark);
        }

        .card {
            position: relative;
        }

        .hidden {
            display: none;
        }

        .graph-trigger {
            cursor: pointer;
            background: rgba(255, 165, 0, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--border);
            transition: all 0.3s;
            text-align: center;
        }

        .graph-trigger:hover {
            border-color: var(--secondary);
            background: rgba(255, 165, 0, 0.1);
        }

        .weight-adjuster {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .weight-arrow {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .weight-arrow:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(255, 57, 57, 0.4);
        }

        .weight-arrow:active {
            transform: scale(0.95);
        }

        .weight-display {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            color: var(--primary);
            min-width: 150px;
            text-align: center;
        }

        .weight-display::-webkit-inner-spin-button,
        .weight-display::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .edit-btn {
            background: rgba(0, 100, 255, 0.2);
            border: none;
            color: #0064FF;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .edit-btn:hover {
            background: #0064FF;
            color: var(--text);
        }

        .delete-icon {
            background: rgba(255, 57, 57, 0.2);
            border: none;
            color: var(--primary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .delete-icon:hover {
            background: var(--primary);
            color: var(--text);
        }

        .draggable {
            cursor: move;
            transition: opacity 0.2s, transform 0.2s;
        }

        .draggable:hover {
            transform: translateX(5px);
        }

        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            border-top: 3px solid var(--primary);
        }

        .drag-handle {
            cursor: grab;
            color: var(--text-dim);
            font-size: 1.2rem;
            margin-right: 10px;
            user-select: none;
        }

                font-size: 0.55rem !important;
            }

        .drag-handle:active {
            cursor: grabbing;
        }

        .ingredient-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
        }

        .ingredient-row input {
            padding: 10px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
        }

        .ingredient-row input:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .shopping-item {
            display: grid;
            grid-template-columns: auto 2fr 0.8fr 0.8fr 0.8fr auto;
            gap: 10px;
            align-items: center;
            background: rgba(255, 165, 0, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--secondary);
            transition: all 0.3s;
        }

        .shopping-item:hover {
            background: rgba(255, 165, 0, 0.1);
        }

        .shopping-item.completed {
            opacity: 0.5;
            border-left-color: var(--success);
        }

        .shopping-item .ingredient-name {
            color: var(--text);
            font-weight: 600;
        }

        .shopping-item .quantity {
            color: var(--text-dim);
            font-size: 0.9rem;
        }
        
        .shopping-item .drag-handle {
            margin-right: 5px;
        }

        /* Mobile-specific styles - kun p√• sm√• sk√¶rme */
        @media screen and (max-width: 768px) {
            /* Undg√• horizontal scroll */
            body {
                overflow-x: hidden;
            }
            
            .container {
                max-width: 100vw;
                padding: 10px;
                margin: 0;
                box-sizing: border-box;
            }
            
            
            /* Reducer header st√∏rrelse */
            .header {
                padding: 20px 10px;
            }
            
            .header h1 {
                font-size: clamp(2rem, 6vw, 4rem);
            }
            
            /* Mindre padding i cards */
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            /* G√∏r nav tabs scrollable hvis for mange */
            .nav-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav-tab {
                flex-shrink: 0;
            }
            
            /* Mindre form grid p√• mobil */
            .form-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            /* Stat grid responsive */
            .stat-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
            }
            
            /* Ingredient rows stacked p√• mobil */
            .ingredient-row {
                grid-template-columns: 2fr 1fr 1fr auto !important;
                gap: 8px !important;
            }
            
            /* Shopping items responsive */
            .shopping-item {
                grid-template-columns: auto 2fr 0.6fr 0.6fr 0.6fr !important;
                gap: 5px !important;
                padding: 10px !important;
                font-size: 0.85rem;
            }
        }
        
        /* Landscape mobil optimization */
        /* PORTRAIT MODE - Meget kompakt til mobil */
        @media screen and (max-width: 768px) and (orientation: portrait) {

            /* Shopping list - kompakt p√• mobil */
            .shopping-item {
                padding: 8px !important;
                gap: 5px !important;
                margin-bottom: 6px !important;
                font-size: 0.85rem !important;
            }
            
            .shopping-item .ingredient-name {
                font-size: 0.85rem !important;
            }
            
            .shopping-item .quantity {
                font-size: 0.75rem !important;
            }
            
            .shopping-item .checkbox {
                width: 20px !important;
                height: 20px !important;
                min-width: 20px !important;
            }
            
            .shopping-item .delete-btn {
                padding: 4px 8px !important;
                font-size: 0.7rem !important;
            }
            
            /* Shopping list header - kompakt med smallere kolonner */
            div[style*="grid-template-columns: auto 2fr 0.8fr 0.8fr 0.8fr"] {
                padding: 6px 8px !important;
                gap: 5px !important;
                font-size: 0.7rem !important;
                margin-bottom: 6px !important;
                grid-template-columns: auto 2fr 0.5fr 0.5fr 0.5fr !important;
            }
            
            /* Shopping items - smallere kolonner */
            .shopping-item[style*="grid-template-columns"] {
                grid-template-columns: auto 2fr 0.5fr 0.5fr 0.5fr auto !important;
            }
            
            /* Shopping modal items - meget kompakt */
            div[style*="z-index: 9999"] div[style*="grid-template-columns: 1fr auto auto"] {
                padding: 5px !important;
                gap: 6px !important;
                line-height: 1.2 !important;
                border-radius: 8px !important;
                margin-bottom: 4px !important;
            }
            
            div[style*="z-index: 9999"] div[style*="grid-template-columns: 1fr auto auto"] strong {
                font-size: 0.75rem !important;
            }
            
            div[style*="z-index: 9999"] div[style*="grid-template-columns: 1fr auto auto"] > div:nth-child(2) {
                font-size: 0.8rem !important;
            }
            
            div[style*="z-index: 9999"] .checkbox {
                width: 20px !important;
                height: 20px !important;
                min-width: 20px !important;
            }
            
            /* K√∏b knap og footer - kompakt */
            div[style*="z-index: 9999"] div[style*="padding-top: 15px"] {
                padding-top: 10px !important;
            }
            
            div[style*="z-index: 9999"] div[style*="padding-top: 15px"] p {
                font-size: 0.75rem !important;
                margin-bottom: 10px !important;
            }
            
            div[style*="z-index: 9999"] button[onclick="completeShopping()"] {
                padding: 8px 20px !important;
                font-size: 0.85rem !important;
            }
            /* Prevent overflow */
            html, body {
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }
            
            .container {
                max-width: 100vw !important;
                padding: 8px !important;
                margin: 0 !important;
            }
            
            /* Meget kompakt sticky header */
            .header {
                position: sticky;
                top: 0;
                z-index: 100;
                background: var(--bg);
                padding: 10px 8px !important;
                margin: -8px -8px 10px -8px !important;
                border-bottom: 2px solid var(--border);
            }
            
            .header h1 {
                font-size: 1.5rem !important;
                letter-spacing: 1px !important;
                margin: 0 !important;
            }
            
            /* Kompakte navigation tabs */
            .nav-tabs {
                position: sticky;
                top: 50px;
                z-index: 99;
                background: var(--bg);
                padding: 6px 8px !important;
                margin: 0 -8px 10px -8px !important;
                gap: 3px !important;
                overflow-x: auto !important;
                flex-wrap: wrap !important;
                -webkit-overflow-scrolling: touch !important;
                scrollbar-width: none !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
				justify-content: center !important;
            }
            
            .nav-tabs::-webkit-scrollbar {
                display: none !important;
            }
            
            .nav-tab {
                padding: 8px 8px !important;
                font-size: 0.65rem !important;
                white-space: nowrap !important;
                flex-shrink: 0 !important;
            }
            
            /* Meget kompakte cards */
            .card {
                padding: 10px !important;
                margin-bottom: 10px !important;
                border-radius: 10px !important;
            }
            
            .card h2 {
                font-size: 1.1rem !important;
                margin-bottom: 8px !important;
            }
            
            .card h3 {
                font-size: 0.95rem !important;
                margin-bottom: 6px !important;
            }
            
            /* Override makro span i h2 og h3 titler */
            .card h2 span[style*="font-size: 1.5rem"],
            .card h3 span[style*="font-size: 1.2rem"] {
                font-size: 0.7rem !important;
            }
            
            /* Workout logging set boxes - kompakt mobile */
            /* Target set boxes i oversigt */
            .overview-section div[style*="grid-template-columns: 60px"] {
                grid-template-columns: 40px 1fr 1fr 1.2fr !important;
                gap: 3px !important;
                padding: 4px !important;
                margin-bottom: 3px !important;
            }
            
            /* S√¶t 1, S√¶t 2 titler */
            .overview-section div[style*="grid-template-columns: 60px"] strong[style*="font-size: 1.1rem"] {
                font-size: 0.7rem !important;
                white-space: nowrap !important;
            }
            
            /* Labels (Reps, Kg, Note) */
            .overview-section div[style*="grid-template-columns: 60px"] label[style*="font-size: 0.75rem"] {
                font-size: 0.55rem !important;
                margin-bottom: 1px !important;
            }
            
            /* Input felter */
            .overview-section div[style*="grid-template-columns: 60px"] input[style*="padding: 8px"] {
                padding: 2px !important;
                font-size: 0.65rem !important;
                min-height: 26px !important;
            }
            
            /* Select (Sekunder dropdown) */
            .overview-section div[style*="grid-template-columns: 60px"] select {
                padding: 2px !important;
                font-size: 0.65rem !important;
                min-height: 26px !important;
            }
            
            /* Log Tr√¶ning knap */
            .overview-section button[style*="padding: 12px"] {
                padding: 6px !important;
                margin-top: 4px !important;
                font-size: 0.75rem !important;
            }
            
            /* Stats boxes - 3 i r√¶kke, kompakte */
            .stat-grid {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 6px !important;
                margin-bottom: 10px !important;
            }
            
            .stat-grid .stat-box {
                padding: 6px 4px !important;
                text-align: center !important;
                border-radius: 8px !important;
            }
            
            .stat-box {
                padding: 6px 4px !important;
                text-align: center !important;
                border-radius: 8px !important;
            }
            
			.stat-box h3 {
				font-size: 1.4rem !important;
				margin: 0 !important;
				line-height: 0.9 !important;
			}

			.stat-box span {
				font-size: 0.55rem !important;
				display: block !important;
				margin-top: 2px !important;
			}
			
			/* Override .value og .label classes */
			.stat-box .value {
				font-size: 1.2rem !important;
				line-height: 0.9 !important;
				margin: 0 !important;
				padding: 0 !important;
				display: block !important;
			}
			
			.stat-box .label {
				font-size: 0.5rem !important;
				margin-top: 1px !important;
				letter-spacing: 0.3px !important;
				text-transform: uppercase !important;
				display: block !important;
			}
			
			/* Override inline styles p√• span i .value */
			.stat-box .value span {
				font-size: 0.75rem !important;
				display: inline !important;
			}
            
            /* Kompakt dag selector */
            .day-selector {
                display: flex !important;
                gap: 2px !important;
                margin-bottom: 10px !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                scrollbar-width: none !important;
            }
            
            .day-selector::-webkit-scrollbar {
                display: none !important;
            }
            
            .day-btn {
                padding: 6px 7px !important;
                font-size: 0.65rem !important;
                flex-shrink: 0 !important;
            }
            
            /* Mindre knapper */
            .btn-add {
                padding: 10px 16px !important;
                font-size: 0.85rem !important;
                max-width: none !important;
                margin-top: 10px !important;
            }
            
			.edit-toggle {
				padding: 4px 10px !important;
				font-size: 0.65rem !important;
				margin-bottom: 20px !important;
				top: 5px !important;
				right: 8px !important;
			}

			.edit-btn, .delete-btn {
				padding: 4px 8px !important;
				font-size: 0.65rem !important;
				min-height: 28px !important;
			}
            
            .delete-icon {
                width: 32px !important;
                height: 32px !important;
                font-size: 0.9rem !important;
            }
            
			/* M√•ltids-form layout */
			/* Lav parent til grid container og b√∏rn til grid items */
			/* Specifik for m√•ltider - identificer via den unikke struktur */
			#mealName {
				/* Marker at dette er m√•ltids form */
			}
			
			/* Find m√•ltids add-form via mealName input */
			#mealName:not(.hidden) ~ *,
			.add-form:has(#mealName) > div.form-grid:first-of-type,
			.add-form:has(#mealName) > div.form-grid:nth-of-type(2) {
				display: contents !important;
			}
			
			/* Wrapper bliver grid container - men kun for m√•ltids form */
			.add-form:has(#mealName):not(.hidden) {
				display: grid !important;
				grid-template-columns: repeat(4, 1fr) !important;
				gap: 2px !important;
			}
			
			/* F√∏rste 2 felter (navn + beskrivelse) fuld bredde */
			.add-form:has(#mealName) > div.form-grid:first-of-type > .form-group {
				grid-column: 1 / -1 !important;
			}
			
			/* Tilf√∏j m√•ltid knap fuld bredde */
			.add-form:has(#mealName) > .btn-add {
				grid-column: 1 / -1 !important;
			}
			
			/* Tilf√∏j mellemrum f√∏r ingredienser */
			.add-form:has(#mealName) > .form-group {
				grid-column: 1 / -1 !important;
				margin-top: 6px !important;
			}
			
			/* N√¶ste 4 felter (makroer) f√•r automatisk 1 kolonne hver */
            /* Reducer form-group margin */
            .form-group {
                margin-bottom: 2px !important;
            }
            
			/* Workout form specifik layout (tr√¶ning side) */
			#content > .card > .add-form > div[style*="grid-template-columns: 1.5fr"] {
				display: grid !important;
				grid-template-columns: repeat(4, 1fr) !important;
				gap: 2px !important;
			}

			/* F√∏rste r√¶kke: √òvelse (2 kolonner) kommer f√∏rst */
			#content > .card > .add-form > div[style*="grid-template-columns: 1.5fr"] > .form-group:nth-child(1) {
				grid-column: span 2 !important;
				order: 1 !important;
			}

			/* Noter (2 kolonner) kommer efter √òvelse p√• f√∏rste r√¶kke */
			#content > .card > .add-form > div[style*="grid-template-columns: 1.5fr"] > .form-group:nth-child(6) {
				grid-column: span 2 !important;
				order: 2 !important;
			}

			/* Anden r√¶kke: S√¶t | Type | Tid/Reps | Kg/Enhed */
			#content > .card > .add-form > div[style*="grid-template-columns: 1.5fr"] > .form-group:nth-child(2) {
				order: 3 !important;
			}

			#content > .card > .add-form > div[style*="grid-template-columns: 1.5fr"] > .form-group:nth-child(3) {
				order: 4 !important;
			}

			#content > .card > .add-form > div[style*="grid-template-columns: 1.5fr"] > .form-group:nth-child(4) {
				order: 5 !important;
			}

			#content > .card > .add-form > div[style*="grid-template-columns: 1.5fr"] > .form-group:nth-child(5) {
				order: 6 !important;
			}
            
            
            .form-group {
                margin-bottom: 2px !important;
            }
            
            .add-form {
                margin-bottom: 15px !important;
            }
            
            .add-form h3 {
                font-size: 0.95rem !important;
                margin-bottom: 10px !important;
            }
            
            label {
                font-size: 0.7rem !important;
                margin-bottom: 1px !important;
                display: block !important;
                font-weight: 600 !important;
            }
            
            input, select, textarea {
                padding: 4px !important;
                font-size: 0.65rem !important;
                min-height: 30px !important;
                max-width: none !important;
            }
            
            textarea {
                min-height: 60px !important;
            }
            
            /* Ingrediens rows kompakte */
            #ingredientRows > div {
                margin-bottom: 3px !important;
            }
            
            /* VIGTIGT: Override inline styles for ingredient-row i portrait mode */
            #ingredientRows .ingredient-row {
                display: grid !important;
                grid-template-columns: 2fr 1fr 1fr 40px !important;
                gap: 3px !important;
            }
            
            #ingredientRows input {
                padding: 4px !important;
                font-size: 0.75rem !important;
                min-height: 30px !important;
            }
            
            /* Delete icon i ingredienser */
            #ingredientRows .delete-icon {
                width: 28px !important;
                height: 28px !important;
                font-size: 0.85rem !important;
            }
            
            /* Kompakte item lists */
            .item-list {
                margin: 0 !important;
            }
            
            .item-list li {
                padding: 6px !important;
                margin-bottom: 4px !important;
                font-size: 0.7rem !important;
            }
            
            .item strong {
                font-size: 0.8rem !important;
                display: block !important;
                margin-bottom: 0px !important;
            }
            
            /* Mindre span tekst i items (som "M√•l: 3 s√¶t √ó 10") */
            .item span {
                font-size: 0.65rem !important;
            }
            
            /* Specifik override for workout li items (inline styles) */
            ul li[style*="padding: 15px"] {
                padding: 6px !important;
                margin-bottom: 4px !important;
            }
            
            ul li[style*="padding: 15px"] strong[style*="font-size: 1.1rem"] {
                font-size: 0.8rem !important;
            }
            
            ul li[style*="padding: 15px"] span[style*="font-size: 0.9rem"] {
                font-size: 0.65rem !important;
            }
            
            ul li[style*="padding: 15px"] span[style*="font-size: 0.85rem"] {
                font-size: 0.6rem !important;
            }
            
            /* Override for oversigt workout divs (ikke li) */
            .overview-section div[style*="padding: 15px"] {
                padding: 6px !important;
                margin-bottom: 4px !important;
            }
            
            .overview-section div[style*="padding: 15px"] strong[style*="font-size: 1.1rem"] {
                font-size: 0.8rem !important;
            }
            
            .overview-section div[style*="padding: 15px"] span[style*="font-size: 0.9rem"] {
                font-size: 0.65rem !important;
            }
            
            .overview-section div[style*="padding: 15px"] span[style*="font-size: 0.85rem"] {
                font-size: 0.6rem !important;
            }
            
            .overview-section div[style*="margin-bottom: 15px"] {
                margin-bottom: 4px !important;
            }
            
            /* Mini-card (oversigt boxes) */
            .mini-card {
                padding: 6px !important;
                font-size: 0.7rem !important;
            }
            
            .mini-card strong {
                font-size: 0.85rem !important;
                margin-bottom: 0px !important;
                line-height: 1.2 !important;
            }
            
            .mini-card span {
                font-size: 0.65rem !important;
                line-height: 1.2 !important;
            }
            
            /* Specifik for item-list (m√•ltider, kostplan, dagligvarer) - fjern br mellemrum */
            .item-list li strong {
                display: block !important;
                font-size: 0.85rem !important;
                margin-bottom: 0px !important;
                line-height: 1.2 !important;
            }
            
            .item-list li br:first-of-type {
                display: none !important;
            }
            
            /* Mindre progress bars */
            .progress-bar {
                height: 6px !important;
                margin: 0 0 10px 0 !important;
            }
            
            /* Reducer tekst og margin over progress bars */
            /* F√∏rste progress bar (Kostplan) */
            .card p[style*="margin-bottom: 10px"] {
                margin: 4px 0 1px 0 !important;
                font-size: 0.75rem !important;
            }
            
            /* Anden progress bar (Tr√¶ning) - mere mellemrum over */
            .card p[style*="margin: 20px"] {
                margin: 10px 0 1px 0 !important;
                font-size: 0.75rem !important;
            }
            
            /* Shopping items kompakte */
            .shopping-item {
                padding: 10px !important;
                gap: 6px !important;
                font-size: 0.85rem !important;
            }
            
            /* Checkbox */
            .checkbox {
                width: 32px !important;
                height: 32px !important;
                flex-shrink: 0 !important;
            }
            
            /* Graph trigger */
            .graph-trigger {
                width: 36px !important;
                height: 36px !important;
                font-size: 1rem !important;
            }
            
            /* Drag handle */
            .drag-handle {
                font-size: 1.2rem !important;
                padding: 2px !important;
            }

        /* Scale modal height on smaller screens */
        @media screen and (max-height: 900px) {
            div[style*="z-index: 9999"] .card {
                height: calc(100vh - 40px) !important;
                max-height: calc(100vh - 40px) !important;
            }
        }

        /* 1. Dynamic navigation - knapper deler bredden lige */
        .nav-tab {
            flex: 1 1 0 !important;
            min-width: 0 !important;
            text-align: center !important;
        }
        
        .day-btn {
            flex: 1 1 0 !important;
            min-width: 0 !important;
            text-align: center !important;
        }

        /* 2. Dagligvare form - fast grid layout */
        .add-form:has(#householdName) .form-grid {
            grid-template-columns: 2fr 1fr 1fr !important;
            gap: 10px;
        }

        /* 3. Modal styling - konsistent tema */
        div[style*="z-index: 9999"] > .card {
            background: rgba(26, 26, 26, 0.9) !important;
            backdrop-filter: blur(10px) !important;
            border: 2px solid var(--border) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FITNESS JOURNAL</h1>
        </div>

        <div class="nav-tabs" id="navTabs"></div>
        <div id="content"></div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 15, 15, 0.95); z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
        <div style="text-align: center;">
            <!-- Animated spinner -->
            <div style="width: 60px; height: 60px; border: 4px solid rgba(255, 57, 57, 0.2); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 30px;"></div>
            
            <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--primary); margin-bottom: 10px; letter-spacing: 2px;">SYNKRONISERER</h2>
            <p style="color: var(--text-dim); font-size: 0.9rem;">Henter data, vent venligst...</p>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>
        // API Configuration
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyrUOh7JS2VUYIx88nL9N7Z2JTCXRpzoKWf60JDFiZ9P38vEprrlxr4t6LGKQKR6OTc/exec';
        
        // Data
        const DAYS = ['Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag', 'L√∏rdag', 'S√∏ndag'];
        
        const MEALS = {
            'Mandag': [],
            'Tirsdag': [],
            'Onsdag': [],
            'Torsdag': [],
            'Fredag': [],
            'L√∏rdag': [],
            'S√∏ndag': []
        };

        const WORKOUTS = {
            'Mandag': [],
            'Tirsdag': [],
            'Onsdag': [],
            'Torsdag': [],
            'Fredag': [],
            'L√∏rdag': [],
            'S√∏ndag': []
        };

        const SHOPPING = [];

        // State
        let state = {
            activeTab: 'oversigt',
            selectedDay: DAYS[new Date().getDay() === 0 ? 6 : new Date().getDay() - 1],
            weight: 118,
            startWeight: 118,
            goalWeight: 95,
            meals: {},
            workouts: {},
            workoutLog: [], // Log format: [{date, day, workoutId, name, sets, reps, kg, notes}]
            expandedWorkouts: {}, // Track which workouts are expanded for logging
            shopping: {}, // Now: {item: {checked: bool, quantity: string, unit: string, inventory: number}}
            modalShopping: {}, // Separate state for modal checkboxes
            shoppingOrder: [], // Custom order for shopping list items
            householdItems: [], // Dagligvarer like toilet paper, toothpaste etc
            customMeals: { library: [] }, // Library of all meals (not tied to days)
            mealPlan: {}, // NEW: {day: [mealId1, mealId2, ...]} - Max 10 per day
            customWorkouts: {},
            weightHistory: [],
            editMode: {
                stats: false,
                meals: false,
                workouts: false,
                shopping: false,
                household: false,
                kostplan: false
            },
            tempWeight: 118,
            currentIngredients: [{item: '', quantity: '', unit: ''}] // Added unit field
        };

        // Load from localStorage initially
        const saved = localStorage.getItem('fitnessData');
        if (saved) {
            const loadedState = JSON.parse(saved);
            
            // Force these values on every load
            loadedState.activeTab = 'oversigt';
            loadedState.editMode = {
                stats: false,
                meals: false,
                workouts: false,
                shopping: false,
                household: false
            };
            
            // Remove workouts from loaded state - it should always be calculated from workoutLog
            delete loadedState.workouts;
            
            state = {...state, ...loadedState};
        }
        
        // Load from Google Sheets via API
        async function loadFromCloud() {
            console.log('‚òÅÔ∏è Loading from Google Sheets via API...');
            
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                const data = await response.json();
                
                console.log('üì¶ Raw data received from Google Sheets:', data);
                    
                    if (!data) {
                        console.error('‚ùå No data returned from Google Sheets (data is null/undefined)');
                        checkDailyReset();
                        render();
                        return;
                    }
                    
                    // Debug each sheet load individually
                    console.group('üìä Loading data from sheets:');
                    
                    // WeightHistory
                    try {
                        if (data.weightHistory && data.weightHistory.length > 0) {
                            console.log('‚úÖ WeightHistory: ' + data.weightHistory.length + ' entries', data.weightHistory);
                            state.weightHistory = data.weightHistory;
                        } else {
                            console.log('‚ö†Ô∏è WeightHistory: No data');
                        }
                    } catch (e) {
                        console.error('‚ùå WeightHistory failed:', e);
                    }
                    
                    // Meals
                    try {
                        if (data.meals && data.meals.length > 0) {
                            console.log('‚úÖ Meals: ' + data.meals.length + ' entries', data.meals);
                            state.customMeals = { library: convertMealsFromArray(data.meals) };
                        } else {
                            console.log('‚ö†Ô∏è Meals: No data');
                            state.customMeals = { library: [] };
                        }
                    } catch (e) {
                        console.error('‚ùå Meals conversion failed:', e);
                        state.customMeals = { library: [] };
                    }
                    
                    // DietPlan
                    try {
                        if (data.dietPlan && data.dietPlan.length > 0) {
                            console.log('‚úÖ DietPlan: ' + data.dietPlan.length + ' entries', data.dietPlan);
                            state.mealPlan = convertDietPlanFromArray(data.dietPlan);
                        } else {
                            console.log('‚ö†Ô∏è DietPlan: No data');
                            state.mealPlan = {};
                        }
                    } catch (e) {
                        console.error('‚ùå DietPlan conversion failed:', e);
                        state.mealPlan = {};
                    }
                    
                    // Workouts
                    try {
                        if (data.workouts && data.workouts.length > 0) {
                            console.log('‚úÖ Workouts: ' + data.workouts.length + ' entries', data.workouts);
                            state.customWorkouts = convertWorkoutsFromArray(data.workouts);
                        } else {
                            console.log('‚ö†Ô∏è Workouts: No data');
                        }
                    } catch (e) {
                        console.error('‚ùå Workouts conversion failed:', e);
                    }
                    
                    // WorkoutLog
                    try {
                        if (data.workoutLog && data.workoutLog.length > 0) {
                            console.log('‚úÖ WorkoutLog: ' + data.workoutLog.length + ' entries', data.workoutLog);
                            state.workoutLog = data.workoutLog;
                        } else {
                            console.log('‚ö†Ô∏è WorkoutLog: No data - clearing local logs');
                            state.workoutLog = []; // Clear localStorage logs if sheet is empty
                        }
                    } catch (e) {
                        console.error('‚ùå WorkoutLog failed:', e);
                    }
                    
                    // Shopping
                    try {
                        if (data.shopping && data.shopping.length > 0) {
                            console.log('‚úÖ Shopping: ' + data.shopping.length + ' entries', data.shopping);
                            state.shopping = convertShoppingFromArray(data.shopping);
                            state.shoppingOrder = data.shopping.map(s => s.item);
                        } else {
                            console.log('‚ö†Ô∏è Shopping: No data');
                        }
                    } catch (e) {
                        console.error('‚ùå Shopping conversion failed:', e);
                    }
                    
                    // HouseholdItems
                    try {
                        if (data.householdItems && data.householdItems.length > 0) {
                            console.log('‚úÖ HouseholdItems: ' + data.householdItems.length + ' entries', data.householdItems);
                            state.householdItems = data.householdItems;
                        } else {
                            console.log('‚ö†Ô∏è HouseholdItems: No data');
                        }
                    } catch (e) {
                        console.error('‚ùå HouseholdItems failed:', e);
                    }
                    
                    // Completions (only load meal completions - workout completions come from workoutLog)
                    try {
                        if (data.completions && data.completions.length > 0) {
                            console.log('‚úÖ Completions: ' + data.completions.length + ' entries', data.completions);
                            const comps = convertCompletionsFromArray(data.completions);
                            state.meals = comps.meals;
                            // NOTE: state.workouts is NOT loaded from completions
                            // It is calculated dynamically from workoutLog (today's logs only)
                        } else {
                            console.log('‚ö†Ô∏è Completions: No data - clearing local completions');
                            state.meals = {}; // Clear localStorage completions if sheet is empty
                        }
                    } catch (e) {
                        console.error('‚ùå Completions conversion failed:', e);
                    }
                    
                    // Settings
                    try {
                        if (data.settings) {
                            console.log('‚úÖ Settings:', data.settings);
                            state.startWeight = parseFloat(data.settings.startWeight) || state.startWeight;
                            state.goalWeight = parseFloat(data.settings.goalWeight) || state.goalWeight;
                            state.weight = parseFloat(data.settings.currentWeight) || state.weight;
                            state.tempWeight = state.weight;
                        } else {
                            console.log('‚ö†Ô∏è Settings: No data');
                        }
                    } catch (e) {
                        console.error('‚ùå Settings failed:', e);
                    }
                    
                    console.groupEnd();
                    console.log('‚úÖ Data loading complete!');
                    
                    // Force default view state
                    state.activeTab = 'oversigt';
                    state.editMode = {
                        stats: false,
                        meals: false,
                        workouts: false,
                        shopping: false,
                        household: false
                    };
                    
                    // Save merged data to localStorage
                    localStorage.setItem('fitnessData', JSON.stringify(state));
                    
                    console.log('üîÑ Google Sheets data loaded - updating UI');
                    checkDailyReset();
                    render(); // Re-render with fresh Google Sheets data
                    
                    // Hide loading overlay
                    const overlay = document.getElementById('loadingOverlay');
                    if (overlay) {
                        overlay.style.opacity = '0';
                        overlay.style.transition = 'opacity 0.3s ease';
                        setTimeout(() => overlay.remove(), 300);
                    }
            } catch (error) {
                console.error('‚ùå Failed to load from Google Sheets:', error);
                console.log('Using localStorage data');
                
                // Force defaults even on failure
                state.activeTab = 'oversigt';
                state.editMode = {
                    stats: false,
                    meals: false,
                    workouts: false,
                    shopping: false,
                    household: false
                };
                
                checkDailyReset();
                render();
                
                // Hide loading overlay even on failure
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => overlay.remove(), 300);
                }
            }
        }

        // Helper functions to convert from Google Sheets format
        function convertMealsFromArray(mealsArray) {
            // Convert array to library format (no days)
            const library = [];
            
            mealsArray.forEach(meal => {
                library.push({
                    id: meal.mealId,
                    name: meal.name,
                    desc: meal.desc,
                    cal: meal.cal,
                    protein: meal.protein,
                    carbs: meal.carbs,
                    fat: meal.fat,
                    ingredients: typeof meal.ingredients === 'string' ? JSON.parse(meal.ingredients) : meal.ingredients
                });
            });
            
            return library;
        }

        function convertDietPlanFromArray(dietPlanArray) {
            // Convert array to mealPlan object {day: [mealId1, mealId2, ...]}
            const mealPlan = {};
            DAYS.forEach(day => { mealPlan[day] = []; });
            
            dietPlanArray.forEach(entry => {
                if (entry.day && mealPlan[entry.day]) {
                    mealPlan[entry.day].push(entry.mealId);
                }
            });
            
            return mealPlan;
        }

        function convertWorkoutsFromArray(workoutsArray) {
            const workouts = {};
            DAYS.forEach(day => { workouts[day] = []; });
            
            workoutsArray.forEach(workout => {
                if (workout.day && workouts[workout.day]) {
                    workouts[workout.day].push({
                        id: workout.workoutId,
                        name: workout.name,
                        sets: String(workout.sets || ''),
                        value: String(workout.value || ''),
                        type: workout.type || 'reps',
                        unit: String(workout.unit || ''),
                        notes: workout.notes || ''
                    });
                }
            });
            
            return workouts;
        }

        function convertShoppingFromArray(shoppingArray) {
            const shopping = {};
            
            shoppingArray.forEach(item => {
                shopping[item.item] = {
                    inventory: item.inventory || 0,
                    unit: item.unit || ''
                    // Note: toBuy is calculated dynamically, not stored in state
                };
            });
            
            return shopping;
        }

        function convertCompletionsFromArray(completionsArray) {
            const meals = {};
            const workouts = {};
            
            completionsArray.forEach(comp => {
                if (comp.completed) {
                    const key = `${comp.day}-${comp.itemId}`;
                    if (comp.type === 'meal') {
                        meals[key] = true;
                    } else if (comp.type === 'workout') {
                        workouts[key] = true;
                    }
                }
            });
            
            return { meals, workouts };
        }
        
        // Check if we need to reset today's completions
        function checkDailyReset() {
            const today = new Date().toDateString();
            const lastReset = localStorage.getItem('lastResetDate');
            
            if (lastReset !== today) {
                // New day! Reset today's day completions
                const currentDay = DAYS[new Date().getDay() === 0 ? 6 : new Date().getDay() - 1];
                
                // Clear meal completions for current day
                Object.keys(state.meals).forEach(key => {
                    if (key.startsWith(currentDay + '-')) {
                        delete state.meals[key];
                    }
                });
                
                // Clear workout completions for current day
                Object.keys(state.workouts).forEach(key => {
                    if (key.startsWith(currentDay + '-')) {
                        delete state.workouts[key];
                    }
                });
                
                // Save reset date
                localStorage.setItem('lastResetDate', today);
                save();
            }
        }
        
        function save() {
            // Create a copy of state with editMode reset
            const stateToSave = {
                ...state,
                activeTab: 'oversigt',  // Always reset to oversigt
                editMode: {
                    stats: false,
                    meals: false,
                    workouts: false,
                    shopping: false,
                    household: false
                }
            };
            
            // Save to localStorage with defaults
            localStorage.setItem('fitnessData', JSON.stringify(stateToSave));
            
            // Sync to Google Sheets in background
            syncToCloud();
        }

        function syncToCloud() {
            console.log('‚òÅÔ∏è Syncing to Google Sheets via API...');
            
            try {
                // Prepare data for Google Sheets
                const payload = {
                    weightHistory: state.weightHistory || [],
                    meals: convertMealsToArray(),
                    dietPlan: convertDietPlanToArray(),
                    workouts: convertWorkoutsToArray(),
                    workoutLog: state.workoutLog || [],
                    shopping: convertShoppingToArray(),
                    householdItems: state.householdItems || [],
                    completions: convertCompletionsToArray(),
                    settings: {
                        startWeight: state.startWeight,
                        goalWeight: state.goalWeight,
                        currentWeight: state.weight
                    }
                };
                
                // Use JSONP to avoid CORS issues
                const callbackName = 'syncCallback_' + Date.now();
                window[callbackName] = function(result) {
                    console.log('‚úÖ Synced to Google Sheets:', result);
                    delete window[callbackName];
                    document.body.removeChild(script);
                };
                
                const script = document.createElement('script');
                const params = new URLSearchParams({
                    action: 'save',
                    data: JSON.stringify(payload),
                    callback: callbackName
                });
                script.src = APPS_SCRIPT_URL + '?' + params.toString();
                script.onerror = function() {
                    console.error('‚ùå Sync failed: Could not reach server');
                    delete window[callbackName];
                    document.body.removeChild(script);
                };
                document.body.appendChild(script);
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
            }
        }

        // Helper functions to convert state to Google Sheets format
        function convertMealsToArray() {
            const meals = [];
            const mealLibrary = state.customMeals.library || [];
            
            mealLibrary.forEach(meal => {
                meals.push({
                    mealId: meal.id,
                    name: meal.name,
                    desc: meal.desc,
                    cal: meal.cal || '',
                    protein: meal.protein || '',
                    carbs: meal.carbs || '',
                    fat: meal.fat || '',
                    ingredients: JSON.stringify(meal.ingredients || [])
                });
            });
            
            return meals;
        }

        function convertDietPlanToArray() {
            const dietPlan = [];
            
            DAYS.forEach(day => {
                if (state.mealPlan[day]) {
                    state.mealPlan[day].forEach(mealId => {
                        dietPlan.push({
                            day: day,
                            mealId: mealId
                        });
                    });
                }
            });
            
            return dietPlan;
        }

        function convertWorkoutsToArray() {
            const workoutsArray = [];
            
            Object.entries(state.customWorkouts).forEach(([day, workouts]) => {
                workouts.forEach(workout => {
                    workoutsArray.push({
                        day: day,
                        workoutId: workout.id,
                        originalName: workout.originalName || '',
                        name: workout.name,
                        sets: workout.sets,
                        value: workout.value || '',
                        type: workout.type || 'reps',
                        unit: workout.unit || '',
                        notes: workout.notes || ''
                    });
                });
            });
            
            return workoutsArray;
        }

        function convertShoppingToArray() {
            const shopping = [];
            
            // Aggregate to calculate toBuy
            const aggregatedItems = {};
            
            // Calculate total quantity needed from meals
            DAYS.forEach(day => {
                if (state.customMeals[day]) {
                    state.customMeals[day].forEach(meal => {
                        if (meal.ingredients) {
                            meal.ingredients.forEach(ing => {
                                if (ing.item) {
                                    if (!aggregatedItems[ing.item]) {
                                        aggregatedItems[ing.item] = {
                                            totalQuantity: 0,
                                            unit: ing.unit || ''
                                        };
                                    }
                                    const qty = parseFloat(ing.quantity);
                                    if (!isNaN(qty)) {
                                        aggregatedItems[ing.item].totalQuantity += qty;
                                    }
                                    if (!aggregatedItems[ing.item].unit && ing.unit) {
                                        aggregatedItems[ing.item].unit = ing.unit;
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            // Add household items total quantity
            if (state.householdItems && state.householdItems.length > 0) {
                state.householdItems.forEach(item => {
                    if (!aggregatedItems[item.name]) {
                        aggregatedItems[item.name] = {
                            totalQuantity: 0,
                            unit: item.unit || ''
                        };
                    }
                    const qty = parseFloat(item.quantity);
                    if (!isNaN(qty)) {
                        aggregatedItems[item.name].totalQuantity = qty;
                    }
                });
            }
            
            // Ensure all aggregated items exist in state.shopping
            Object.keys(aggregatedItems).forEach(item => {
                if (!state.shopping[item]) {
                    state.shopping[item] = {
                        inventory: 0,
                        unit: aggregatedItems[item].unit
                    };
                }
            });
            
            // Build shopping array with toBuy calculated
            const allItems = Object.keys(aggregatedItems);
            const order = state.shoppingOrder || allItems;
            
            // Include all items that have aggregated data
            allItems.forEach(item => {
                const inventory = state.shopping[item]?.inventory || 0;
                const totalNeeded = aggregatedItems[item]?.totalQuantity || 0;
                const toBuy = Math.max(0, Math.round(totalNeeded - inventory));
                const orderIndex = order.indexOf(item);
                
                shopping.push({
                    item: item,
                    inventory: inventory,
                    toBuy: toBuy,
                    unit: state.shopping[item]?.unit || aggregatedItems[item]?.unit || '',
                    orderIndex: orderIndex === -1 ? 999 : orderIndex
                });
            });
            
            // Sort by orderIndex
            shopping.sort((a, b) => a.orderIndex - b.orderIndex);
            
            return shopping;
        }

        function convertCompletionsToArray() {
            const completions = [];
            const today = new Date().toISOString().split('T')[0];
            
            // Meals completions
            Object.keys(state.meals).forEach(key => {
                if (state.meals[key]) {
                    const [day, itemId] = key.split('-');
                    completions.push({
                        day: day,
                        type: 'meal',
                        itemId: itemId,
                        completed: true,
                        completedDate: today
                    });
                }
            });
            
            // Workouts completions - dynamically calculate from today's workoutLog
            // Get unique workout+day combinations that have logs today
            const workoutsLoggedToday = new Set();
            (state.workoutLog || []).forEach(log => {
                if (log.date === today) {
                    const key = `${log.day}-${log.name}`;
                    workoutsLoggedToday.add(key);
                }
            });
            
            // Convert to completions array
            workoutsLoggedToday.forEach(key => {
                const [day, itemId] = key.split('-');
                completions.push({
                    day: day,
                    type: 'workout',
                    itemId: itemId,
                    completed: true,
                    completedDate: today
                });
            });
            
            console.log('üìä Workout completions to sync (based on today\'s logs):', completions.filter(c => c.type === 'workout'));
            
            return completions;
        }

        let hasInitialRendered = false;
        
        function render() {
            // ONLY force defaults on FIRST render (page load)
            if (!hasInitialRendered) {
                console.log('üéØ Initial render - forcing defaults');
                state.activeTab = 'oversigt';
                state.editMode = {
                    stats: false,
                    meals: false,
                    workouts: false,
                    shopping: false,
                    household: false
                };
                hasInitialRendered = true;
            }
            
            renderNav();
            renderContent();
            initDragAndDrop();
        }

        function initDragAndDrop() {
            const draggables = document.querySelectorAll('.draggable');
            
            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', handleDragStart);
                draggable.addEventListener('dragend', handleDragEnd);
                draggable.addEventListener('dragover', handleDragOver);
                draggable.addEventListener('drop', handleDrop);
                draggable.addEventListener('dragenter', handleDragEnter);
                draggable.addEventListener('dragleave', handleDragLeave);
            });
        }

        let draggedElement = null;
        let draggedIndex = null;
        let draggedType = null;

        function handleDragStart(e) {
            draggedElement = this;
            draggedIndex = parseInt(this.dataset.index);
            draggedType = this.dataset.type;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            // Add drag-over class to entire item if same type
            if (this.dataset.type === draggedType && this !== draggedElement) {
                this.classList.add('drag-over');
            }
            
            return false;
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (this.dataset.type === draggedType && this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            // Only remove if we're actually leaving the element
            if (e.target === this) {
                this.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            this.classList.remove('drag-over');
            
            const dropIndex = parseInt(this.dataset.index);
            
            if (draggedIndex !== dropIndex && this.dataset.type === draggedType) {
                if (draggedType === 'meal') {
                    reorderMeals(draggedIndex, dropIndex);
                } else if (draggedType === 'workout') {
                    reorderWorkouts(draggedIndex, dropIndex);
                } else if (draggedType === 'shopping') {
                    reorderShopping(draggedIndex, dropIndex);
                }
            }
            
            return false;
        }

        function reorderShopping(fromIndex, toIndex) {
            // Get current shopping items in display order
            const aggregatedItems = {};
            
            // Add ingredients from meals
            DAYS.forEach(day => {
                if (state.customMeals[day]) {
                    state.customMeals[day].forEach(meal => {
                        if (meal.ingredients) {
                            meal.ingredients.forEach(ing => {
                                if (ing.item && !aggregatedItems[ing.item]) {
                                    aggregatedItems[ing.item] = true;
                                }
                            });
                        }
                    });
                }
            });
            
            // Add household items
            if (state.householdItems && state.householdItems.length > 0) {
                state.householdItems.forEach(item => {
                    aggregatedItems[item.name] = true;
                });
            }
            
            let itemKeys = Object.keys(aggregatedItems);
            
            // Apply current order
            if (state.shoppingOrder && state.shoppingOrder.length > 0) {
                itemKeys.sort((a, b) => {
                    const indexA = state.shoppingOrder.indexOf(a);
                    const indexB = state.shoppingOrder.indexOf(b);
                    if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });
            } else {
                itemKeys.sort();
            }
            
            // Reorder
            const [movedItem] = itemKeys.splice(fromIndex, 1);
            itemKeys.splice(toIndex, 0, movedItem);
            
            // Save new order
            state.shoppingOrder = itemKeys;
            
            save();
            render();
        }

        function reorderMeals(fromIndex, toIndex) {
            // Get converted meal names
            const convertedNames = new Set();
            if (state.customMeals[state.selectedDay]) {
                state.customMeals[state.selectedDay].forEach(m => {
                    if (m.originalName) convertedNames.add(m.originalName);
                });
            }
            
            // Build combined array
            const defaultMeals = (MEALS[state.selectedDay] || []).filter(m => !convertedNames.has(m.name));
            const allMeals = [...defaultMeals, ...(state.customMeals[state.selectedDay] || [])];
            
            // Reorder
            const [movedItem] = allMeals.splice(fromIndex, 1);
            allMeals.splice(toIndex, 0, movedItem);
            
            // Update state - we need to rebuild the arrays
            // For simplicity, convert all to custom meals with order property
            if (!state.customMeals[state.selectedDay]) state.customMeals[state.selectedDay] = [];
            
            // Clear and rebuild with new order
            state.customMeals[state.selectedDay] = allMeals.map((m, idx) => ({
                ...m,
                id: m.id || Date.now() + idx,
                order: idx
            }));
            
            save();
            render();
        }

        function reorderWorkouts(fromIndex, toIndex) {
            // Get converted workout names
            const convertedNames = new Set();
            if (state.customWorkouts[state.selectedDay]) {
                state.customWorkouts[state.selectedDay].forEach(w => {
                    if (w.originalName) convertedNames.add(w.originalName);
                });
            }
            
            // Build combined array
            const defaultWorkouts = (WORKOUTS[state.selectedDay] || []).filter(w => !convertedNames.has(w.name));
            const allWorkouts = [...defaultWorkouts, ...(state.customWorkouts[state.selectedDay] || [])];
            
            // Reorder
            const [movedItem] = allWorkouts.splice(fromIndex, 1);
            allWorkouts.splice(toIndex, 0, movedItem);
            
            // Update state
            if (!state.customWorkouts[state.selectedDay]) state.customWorkouts[state.selectedDay] = [];
            
            // Clear and rebuild with new order
            state.customWorkouts[state.selectedDay] = allWorkouts.map((w, idx) => ({
                ...w,
                id: w.id || Date.now() + idx,
                order: idx
            }));
            
            save();
            render();
        }

        function renderNav() {
            const nav = document.getElementById('navTabs');
            nav.innerHTML = `
                <button class="nav-tab ${state.activeTab === 'oversigt' ? 'active' : ''}" onclick="setTab('oversigt')">Oversigt</button>
                <button class="nav-tab ${state.activeTab === 'tr√¶ning' ? 'active' : ''}" onclick="setTab('tr√¶ning')">Tr√¶ning</button>
                <button class="nav-tab ${state.activeTab === 'kostplan' ? 'active' : ''}" onclick="setTab('kostplan')">Kostplan</button>
                <button class="nav-tab ${state.activeTab === 'kost' ? 'active' : ''}" onclick="setTab('kost')">M√•ltider</button>
                <button class="nav-tab ${state.activeTab === 'dagligvarer' ? 'active' : ''}" onclick="setTab('dagligvarer')">Dagligvarer</button>
                <button class="nav-tab ${state.activeTab === 'indk√∏b' ? 'active' : ''}" onclick="setTab('indk√∏b')">Indk√∏b</button>
            `;
        }

        function renderContent() {
            const content = document.getElementById('content');
            if (state.activeTab === 'oversigt') content.innerHTML = renderOversigt();
            if (state.activeTab === 'tr√¶ning') content.innerHTML = renderTr√¶ning();
            if (state.activeTab === 'kost') {
                content.innerHTML = renderKost();
                renderIngredientRows(); // Render after DOM is ready
            }
            if (state.activeTab === 'kostplan') content.innerHTML = renderKostplan();
            if (state.activeTab === 'dagligvarer') content.innerHTML = renderDagligvarer();
            if (state.activeTab === 'indk√∏b') content.innerHTML = renderIndk√∏b();
        }

        function renderIngredientRows() {
            const container = document.getElementById('ingredientRows');
            if (!container) return;
            
            // Save which field currently has focus (before re-render)
            const activeElement = document.activeElement;
            let focusIdx = null;
            let focusField = null;
            
            if (activeElement && activeElement.dataset && activeElement.dataset.idx !== undefined) {
                focusIdx = parseInt(activeElement.dataset.idx);
                focusField = activeElement.dataset.field;
            }
            
            // Ensure at least one empty row
            if (state.currentIngredients.length === 0) {
                state.currentIngredients.push({item: '', quantity: '', unit: ''});
            }
            
            // Get all existing ingredients for suggestions
            const allIngredients = new Set();
            Object.values(state.customMeals).forEach(dayMeals => {
                dayMeals.forEach(meal => {
                    if (meal.ingredients) {
                        meal.ingredients.forEach(ing => allIngredients.add(ing.item));
                    }
                });
            });
            
            container.innerHTML = state.currentIngredients.map((ing, idx) => `
                <div class="ingredient-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 10px; margin-bottom: 10px; align-items: end;">
                    <div>
                        ${idx === 0 ? '<label style="display: block; color: var(--text-dim); font-size: 0.85rem; margin-bottom: 5px;">Ingredienser</label>' : ''}
                        <input 
                            type="text" 
                            list="ingredientSuggestions"
                            value="${ing.item || ''}"
                            data-idx="${idx}"
                            data-field="item"
                            oninput="updateIngredientValue(${idx}, 'item', this.value)"
                            onkeydown="handleIngredientKeydown(event, ${idx}, 'item')"
                            style="width: 100%; padding: 10px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem;"
                        />
                    </div>
                    <div>
                        ${idx === 0 ? '<label style="display: block; color: var(--text-dim); font-size: 0.85rem; margin-bottom: 5px;">Antal</label>' : ''}
                        <input 
                            type="text"
                            value="${ing.quantity || ''}"
                            data-idx="${idx}"
                            data-field="quantity"
                            oninput="updateIngredientValue(${idx}, 'quantity', this.value)"
                            onkeydown="handleIngredientKeydown(event, ${idx}, 'quantity')"
                            style="width: 100%; padding: 10px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem;"
                        />
                    </div>
                    <div>
                        ${idx === 0 ? '<label style="display: block; color: var(--text-dim); font-size: 0.85rem; margin-bottom: 5px;">Enhed</label>' : ''}
                        <input 
                            type="text"
                            value="${ing.unit || ''}"
                            list="unitSuggestions"
                            data-idx="${idx}"
                            data-field="unit"
                            oninput="updateIngredientValue(${idx}, 'unit', this.value)"
                            onkeydown="handleIngredientKeydown(event, ${idx}, 'unit')"
                            style="width: 100%; padding: 10px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem;"
                        />
                    </div>
                    ${state.currentIngredients.length > 1 ? `
                        <button type="button" class="delete-icon" onclick="removeIngredientRow(${idx})">‚úï</button>
                    ` : '<div style="width: 40px"></div>'}
                </div>
            `).join('') + `
                <datalist id="ingredientSuggestions">
                    ${Array.from(allIngredients).map(item => `<option value="${item}">`).join('')}
                </datalist>
                <datalist id="unitSuggestions">
                    <option value="stk">
                    <option value="g">
                    <option value="kg">
                    <option value="ml">
                    <option value="l">
                    <option value="dl">
                    <option value="spsk">
                    <option value="tsk">
                    <option value="pakke">
                    <option value="d√•se">
                </datalist>
            `;
            
            // Restore focus after re-render
            if (focusIdx !== null && focusField !== null) {
                setTimeout(() => {
                    const inputs = document.querySelectorAll('#ingredientRows input[type="text"]');
                    const targetInput = Array.from(inputs).find(input => 
                        input.dataset.idx == focusIdx && input.dataset.field === focusField
                    );
                    if (targetInput) {
                        targetInput.focus();
                        // Place cursor at end
                        targetInput.setSelectionRange(targetInput.value.length, targetInput.value.length);
                    }
                }, 0);
            }
        }

        function updateIngredientValue(idx, field, value) {
            // Update the value
            state.currentIngredients[idx][field] = value;
            
            // Check if we need to add a new empty row
            const lastRow = state.currentIngredients[state.currentIngredients.length - 1];
            const isLastRow = idx === state.currentIngredients.length - 1;
            
            // If typing in last row and it now has content, add new empty row
            if (isLastRow && (lastRow.item || lastRow.quantity || lastRow.unit)) {
                state.currentIngredients.push({item: '', quantity: '', unit: ''});
                renderIngredientRows();
            }
        }

        function checkAddNewRow() {
            // Check if last row has content and add new row if needed
            const lastRow = state.currentIngredients[state.currentIngredients.length - 1];
            if (lastRow.item || lastRow.quantity || lastRow.unit) {
                state.currentIngredients.push({item: '', quantity: '', unit: ''});
                renderIngredientRows();
            }
        }

        function handleIngredientKeydown(event, idx, field) {
            if (event.key === 'Tab') {
                // Just save current value
                const value = event.target.value;
                state.currentIngredients[idx][field] = value;
                
                // Let Tab work naturally - no re-render, no preventDefault
                
            } else if (event.key === 'Enter') {
                event.preventDefault();
                
                // Save current value
                const value = event.target.value;
                state.currentIngredients[idx][field] = value;
                
                // Check if this is the last field
                const allInputs = Array.from(document.querySelectorAll('#ingredientRows input[type="text"]'));
                const currentIndex = allInputs.indexOf(event.target);
                const nextInput = allInputs[currentIndex + 1];
                
                if (nextInput) {
                    // Move to next field
                    nextInput.focus();
                } else {
                    // Last field - add new row
                    state.currentIngredients.push({item: '', quantity: '', unit: ''});
                    renderIngredientRows();
                    
                    // Focus first field of new row
                    setTimeout(() => {
                        const newInputs = document.querySelectorAll('#ingredientRows input[type="text"]');
                        if (newInputs[newInputs.length - 3]) {
                            newInputs[newInputs.length - 3].focus();
                        }
                    }, 50);
                }
            }
        }

        function removeIngredientRow(idx) {
            state.currentIngredients.splice(idx, 1);
            if (state.currentIngredients.length === 0) {
                state.currentIngredients.push({item: '', quantity: '', unit: ''});
            }
            renderIngredientRows();
        }

        function getProgressColor(percentage) {
            // Red (0%) -> Yellow (50%) -> Green (100%)
            if (percentage === 0) return '#FF3939';
            if (percentage === 100) return '#00FF88';
            
            if (percentage < 50) {
                // Red to Yellow
                const ratio = percentage / 50;
                const r = 255;
                const g = Math.round(57 + (255 - 57) * ratio);
                const b = Math.round(57 * (1 - ratio));
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                // Yellow to Green
                const ratio = (percentage - 50) / 50;
                const r = Math.round(255 * (1 - ratio));
                const g = 255;
                const b = Math.round(136 + (136 * ratio));
                return `rgb(${r}, ${g}, ${b})`;
            }
        }

        function renderOversigt() {
            // Get meals from kostplan for this day
            const mealLibrary = state.customMeals.library || [];
            const dayMealIds = state.mealPlan[state.selectedDay] || [];
            const allMeals = dayMealIds.map(id => mealLibrary.find(m => m.id === id)).filter(Boolean);
            
            // Get converted workout names to hide originals
            const convertedWorkoutNames = new Set();
            if (state.customWorkouts[state.selectedDay]) {
                state.customWorkouts[state.selectedDay].forEach(w => {
                    if (w.originalName) convertedWorkoutNames.add(w.originalName);
                });
            }
            
            // Filter out converted defaults
            const defaultWorkouts = (WORKOUTS[state.selectedDay] || []).filter(w => !convertedWorkoutNames.has(w.name));
            
            const allWorkouts = [...defaultWorkouts, ...(state.customWorkouts[state.selectedDay] || [])];
            
            const completedMeals = allMeals.filter(m => state.meals[`${state.selectedDay}-${m.id}`]).length;
            
            // Calculate completedWorkouts based on today's workoutLog
            const today = new Date().toISOString().split('T')[0];
            const completedWorkouts = allWorkouts.filter(w => {
                const workoutName = w.name || w.id;
                return (state.workoutLog || []).some(log => 
                    log.name === workoutName && 
                    log.day === state.selectedDay && 
                    log.date === today
                );
            }).length;
            
            const mealProg = allMeals.length > 0 ? (completedMeals / allMeals.length) * 100 : 100;
            const workoutProg = allWorkouts.length > 0 ? (completedWorkouts / allWorkouts.length) * 100 : 100;

            // Calculate total macros for oversigt
            const totals = allMeals.reduce((acc, m) => {
                acc.cal += m.cal || 0;
                acc.protein += m.protein || 0;
                acc.carbs += m.carbs || 0;
                acc.fat += m.fat || 0;
                return acc;
            }, {cal: 0, protein: 0, carbs: 0, fat: 0});

            return `
                <div class="card">
                    <button class="edit-toggle ${state.editMode.stats ? 'active' : ''}" onclick="toggleEditMode('stats')">
                        ${state.editMode.stats ? '‚úì F√¶rdig' : '‚úèÔ∏è Rediger'}
                    </button>
                    
                    <h2 style="display: flex; align-items: center; gap: 8px;">
                        V√¶gt Statistik
                        ${state.weightHistory.length > 0 ? `
                            <div onclick="showWeightGraph()" style="display: inline-flex; align-items: center; justify-content: center; padding: 0px 6px 4px 6px; margin-top: -4px; background: rgba(255, 57, 57, 0.1); border: 2px solid var(--primary); border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255, 57, 57, 0.2)'; this.style.borderColor='var(--secondary)'" onmouseout="this.style.background='rgba(255, 57, 57, 0.1)'; this.style.borderColor='var(--primary)'">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                </svg>
                            </div>
                        ` : ''}
                    </h2>
                    
                    ${state.editMode.stats ? `
                        <div class="weight-adjuster">
                            <button class="weight-arrow" onclick="adjustWeight(-0.1)">‚óÄ</button>
                            <input 
                                type="number" 
                                step="0.1" 
                                class="weight-display" 
                                value="${state.tempWeight.toFixed(1)}"
                                onchange="state.tempWeight = parseFloat(this.value); render();"
                                style="border: 2px solid var(--primary); background: var(--bg-dark); border-radius: 12px; padding: 10px; text-align: center; cursor: text;"
                            />
                            <button class="weight-arrow" onclick="adjustWeight(0.1)">‚ñ∂</button>
                        </div>
                        <p style="text-align: center; color: var(--text-dim); margin-bottom: 20px">Juster din nuv√¶rende v√¶gt</p>
                    ` : `
                        <div class="stat-grid">
                            <div class="stat-box">
                                <div class="value">${state.weight.toFixed(1)} <span style="font-size: 1.5rem">kg</span></div>
                                <div class="label">NUV√ÜRENDE</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">${(state.startWeight - state.weight).toFixed(1)} <span style="font-size: 1.5rem">kg</span></div>
                                <div class="label">TABT</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">${Math.max(0, state.weight - state.goalWeight).toFixed(1)} <span style="font-size: 1.5rem">kg</span></div>
                                <div class="label">TIL M√ÖL</div>
                            </div>
                        </div>
                    `}

                    <div style="margin-top: 20px" class="${state.editMode.stats ? '' : 'hidden'}">
                        <h3 style="font-size: 1.2rem; margin-bottom: 10px; color: var(--secondary)">Juster M√•l</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Startv√¶gt (kg)</label>
                                <input type="number" step="0.1" id="startWeightInput" value="${state.startWeight}">
                            </div>
                            <div class="form-group">
                                <label>M√•lv√¶gt (kg)</label>
                                <input type="number" step="0.1" id="goalWeightInput" value="${state.goalWeight}">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    ${renderDaySelector()}
                    <p style="margin-bottom: 10px">Kostplan: ${completedMeals}/${allMeals.length}</p>
                    <div class="progress-bar"><div class="progress-fill" style="width: ${mealProg}%; background: ${getProgressColor(mealProg)}"></div></div>
                    <p style="margin: 20px 0 10px">Tr√¶ning: ${completedWorkouts}/${allWorkouts.length}</p>
                    <div class="progress-bar"><div class="progress-fill" style="width: ${workoutProg}%; background: ${getProgressColor(workoutProg)}"></div></div>

                    <div class="overview-section">
                        <h3>Kostplan${allMeals.length > 0 ? `<span style="font-weight: normal; font-size: 1.2rem;"> - Kcal: ${totals.cal} | P: ${totals.protein}g | K: ${totals.carbs}g | F: ${totals.fat}g</span>` : ''}</h3>
                        ${allMeals.length === 0 ? '<p style="color: var(--text-dim)">Ingen m√•ltider i planen</p>' : allMeals.map(m => {
                            const key = `${state.selectedDay}-${m.id}`;
                            return `<div class="mini-card ${state.meals[key] ? 'completed' : ''}" style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <strong>${m.name}</strong><br>
                                    <span style="color: var(--text-dim); font-size: 0.9rem">${m.desc}</span>
                                    ${m.cal ? `<br><span style="color: var(--secondary); font-size: 0.85rem">${m.cal} kcal | P: ${m.protein || 0}g | K: ${m.carbs || 0}g | F: ${m.fat || 0}g</span>` : ''}
                                </div>
                                <div class="checkbox ${state.meals[key] ? 'checked' : ''}" onclick="toggleMeal('${m.id}')"></div>
                            </div>`;
                        }).join('')}
                    </div>

                    <div class="overview-section">
                        <h3>Tr√¶ning</h3>
                        ${allWorkouts.length === 0 ? '<p style="color: var(--text-dim)">Hviledag</p>' : `
                            <div style="list-style: none; padding: 0;">
                                ${allWorkouts.map(w => {
                                    const key = `${state.selectedDay}-${w.name || w.id}`;
                                    const numSets = parseInt(w.sets) || 3;
                                    const isExpanded = state.expandedWorkouts && state.expandedWorkouts[key];
                                    
                                    // Check if logged today
                                    const today = new Date().toISOString().split('T')[0];
                                    const hasLoggedToday = (state.workoutLog || []).some(log => 
                                        log.name === w.name && log.day === state.selectedDay && log.date === today
                                    );
                                    
                                    return `
                                    <div style="margin-bottom: 15px; padding: 15px; background: rgba(255, 165, 0, 0.05); border-radius: 12px; border-left: 4px solid var(--secondary); opacity: ${hasLoggedToday ? '0.5' : '1'};">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${isExpanded && !hasLoggedToday ? '15px' : '0'};">
                                            <div style="flex: 1;">
                                                <strong style="font-size: 1.1rem;">${w.name}</strong><br>
                                                <span style="color: var(--text-dim); font-size: 0.9rem;">M√•l: ${
                                                    (w.type === 'tid' || w.type === 'time') 
                                                    ? `${w.sets} s√¶t √ó ${w.value || w.reps || '?'} ${w.unit || 'sek'}`
                                                    : `${w.sets} s√¶t √ó ${w.value || w.reps || '?'}${(w.unit || w.kg) ? ` @ ${w.unit || w.kg}kg` : ''}`
                                                }</span>
                                                ${w.notes ? `<br><span style="font-style: italic; color: var(--text-dim); font-size: 0.85rem;">(${w.notes})</span>` : ''}
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <button class="edit-btn" onclick="showWorkoutHistory('${w.name || w.id}', '${state.selectedDay}')" style="background: rgba(255, 165, 0, 0.2); color: var(--secondary); padding: 6px 10px;">üìä</button>
                                                ${hasLoggedToday ? `
                                                    <div class="checkbox checked" onclick="deleteWorkoutLogToday('${w.name}', '${state.selectedDay}')" style="cursor: pointer;"></div>
                                                ` : `
                                                  <button onclick="toggleWorkoutExpand('${key}')" style="background: var(--primary); color: white; border: none; border-radius: 6px; padding: 5px; cursor: pointer; font-weight: 600; font-size: 0.8rem; width: 29px; height: 29px; display: flex; align-items: center; justify-content: center;">
                                                      ${isExpanded ? '‚ñ≤' : '‚ñº'}
                                                  </button>
                                                `}
                                            </div>
                                        </div>
                                        
                                        ${isExpanded && !hasLoggedToday ? `
                                            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--border);">
                                                ${Array.from({length: numSets}, (_, setIdx) => {
                                                    const workoutType = w.type || 'reps';
                                                    const valueLabel = workoutType === 'tid' ? 'Tid' : 'Reps';
                                                    const unitLabel = workoutType === 'tid' ? 'Enhed' : 'Kg';
                                                    // Backward compatibility: use reps/kg if value/unit not available
                                                    const valuePlaceholder = w.value || w.reps || '';
                                                    const unitPlaceholder = w.unit || w.kg || '';
                                                    
                                                    // Build unit field HTML
                                                    let unitFieldHTML = '';
                                                    if (workoutType === 'tid') {
                                                        unitFieldHTML = `
                                                            <select id="log_${key}_unit_${setIdx}" style="width: 100%; padding: 8px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem; text-align: center;">
                                                                <option value="sek" ${unitPlaceholder === 'sek' ? 'selected' : ''}>Sekunder</option>
                                                                <option value="min" ${unitPlaceholder === 'min' ? 'selected' : ''}>Minutter</option>
                                                                <option value="timer" ${unitPlaceholder === 'timer' ? 'selected' : ''}>Timer</option>
                                                            </select>
                                                        `;
                                                    } else {
                                                        unitFieldHTML = `<input type="text" id="log_${key}_unit_${setIdx}" value="${unitPlaceholder}" style="width: 100%; padding: 8px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem; text-align: center;">`;
                                                    }
                                                    
                                                    return `
                                                    <div style="display: grid; grid-template-columns: 60px 1fr 1fr 2fr; gap: 12px; align-items: center; padding: 12px; margin-bottom: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                                                        <strong style="color: var(--secondary); font-size: 1.1rem;">S√¶t ${setIdx + 1}</strong>
                                                        <div>
                                                            <label style="display: block; color: var(--text-dim); font-size: 0.75rem; margin-bottom: 5px;">${valueLabel}</label>
                                                            <input type="text" id="log_${key}_value_${setIdx}" value="${valuePlaceholder}" style="width: 100%; padding: 8px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem; text-align: center;">
                                                        </div>
                                                        <div>
                                                            <label style="display: block; color: var(--text-dim); font-size: 0.75rem; margin-bottom: 5px;">${unitLabel}</label>
                                                            ${unitFieldHTML}
                                                        </div>
                                                        <div>
                                                            <label style="display: block; color: var(--text-dim); font-size: 0.75rem; margin-bottom: 5px;">Note</label>
                                                            <input type="text" id="log_${key}_note_${setIdx}" style="width: 100%; padding: 8px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem;">
                                                        </div>
                                                    </div>
                                                `}).join('')}
                                                <button class="btn-add" onclick="logWorkoutFromInline('${w.name || w.id}', '${key}', ${numSets}, '${w.type || 'reps'}')" style="width: 100%; margin-top: 10px; padding: 12px; font-size: 1rem;">
                                                    ‚úì Log Tr√¶ning
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                `}).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderKost() {
            // Get all custom meals (not per day anymore - it's a library)
            const allMeals = state.customMeals.library || [];
            
            // Calculate total macros
            const totals = allMeals.reduce((acc, m) => {
                acc.cal += m.cal || 0;
                acc.protein += m.protein || 0;
                acc.carbs += m.carbs || 0;
                acc.fat += m.fat || 0;
                return acc;
            }, {cal: 0, protein: 0, carbs: 0, fat: 0});
            
            return `
                <div class="card">
                    <button class="edit-toggle ${state.editMode.meals ? 'active' : ''}" onclick="toggleEditMode('meals')">
                        ${state.editMode.meals ? '‚úì F√¶rdig' : '‚úèÔ∏è Rediger'}
                    </button>
                    
                    <h2>M√•ltider</h2>
                    
                    <div class="add-form ${state.editMode.meals ? '' : 'hidden'}" style="margin-bottom: 30px;">
                        <h3 id="mealFormTitle">+ Tilf√∏j M√•ltid</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>M√•ltid navn</label>
                                <input type="text" id="mealName">
                            </div>
                            <div class="form-group">
                                <label>Beskrivelse</label>
                                <input type="text" id="mealDesc">
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Kalorier</label>
                                <input type="number" id="mealCal">
                            </div>
                            <div class="form-group">
                                <label>Protein</label>
                                <input type="number" id="mealProtein">
                            </div>
                            <div class="form-group">
                                <label>Kulhydrater</label>
                                <input type="number" id="mealCarbs">
                            </div>
                            <div class="form-group">
                                <label>Fedt</label>
                                <input type="number" id="mealFat">
                            </div>
                        </div>
                        <div class="form-group">
                            <div id="ingredientRows"></div>
                        </div>
                        <input type="hidden" id="editingMealId" value="">
                        <button class="btn-add" id="mealSaveBtn" onclick="saveMeal()">+ Tilf√∏j M√•ltid</button>
                    </div>

                    <ul class="item-list">
                        ${allMeals.map((m, i) => {
                            return `<li class="item ${state.editMode.meals ? 'draggable' : ''}" ${state.editMode.meals ? 'draggable="true"' : ''} data-index="${i}" data-type="meal">
                                <div style="display: flex; align-items: center; flex: 1;">
                                    ${state.editMode.meals ? '<span class="drag-handle">‚ãÆ‚ãÆ</span>' : ''}
                                    <div style="flex: 1">
                                        <strong>${m.name}</strong><br>
                                        <span style="color: var(--text-dim); font-size: 0.9rem">${m.desc}</span>
                                        ${m.cal ? `<br><span style="color: var(--secondary); font-size: 0.85rem">${m.cal} kcal | P: ${m.protein || 0}g | K: ${m.carbs || 0}g | F: ${m.fat || 0}g</span>` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px">
                                    ${state.editMode.meals ? `
                                        <button class="edit-btn" onclick="loadMealToEdit(${i})">Ret</button>
                                        <button class="delete-icon" onclick="confirmDeleteMeal(${i})">‚úï</button>
                                    ` : ''}
                                </div>
                            </li>`;
                        }).join('')}
                    </ul>
                </div>
            `;
        }

        function renderTr√¶ning() {
            // Get converted workout names to hide originals
            const convertedNames = new Set();
            if (state.customWorkouts[state.selectedDay]) {
                state.customWorkouts[state.selectedDay].forEach(w => {
                    if (w.originalName) convertedNames.add(w.originalName);
                });
            }
            
            // Filter out converted default workouts
            const defaultWorkouts = (WORKOUTS[state.selectedDay] || []).filter(w => !convertedNames.has(w.name));
            const allWorkouts = [...defaultWorkouts, ...(state.customWorkouts[state.selectedDay] || [])];
            
            return `
                <div class="card">
                    <button class="edit-toggle ${state.editMode.workouts ? 'active' : ''}" onclick="toggleEditMode('workouts')">
                        ${state.editMode.workouts ? '‚úì F√¶rdig' : '‚úèÔ∏è Rediger'}
                    </button>
                    
                    <h2>Tr√¶ning</h2>
                    ${renderDaySelector()}
                    
                    <div class="add-form ${state.editMode.workouts ? '' : 'hidden'}" style="margin-bottom: 30px;">
                        <h3 id="workoutFormTitle">+ Tilf√∏j √òvelse</h3>
                        <div style="display: grid; grid-template-columns: 1.5fr 0.7fr 0.8fr 0.8fr 0.8fr 1.5fr; gap: 15px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label>√òvelse</label>
                                <input type="text" id="exName">
                            </div>
                            <div class="form-group">
                                <label>S√¶t</label>
                                <input type="text" id="exSets">
                            </div>
                            <div class="form-group">
                                <label>Type</label>
                                <select id="exType" onchange="updateWorkoutTypeFields()">
                                    <option value="reps">Reps</option>
                                    <option value="tid">Tid</option>
                                </select>
                            </div>
                            <div class="form-group" id="valueField">
                                <label id="valueLabel">Reps</label>
                                <input type="text" id="exValue">
                            </div>
                            <div class="form-group" id="unitField">
                                <label id="unitLabel">Kg</label>
                                <input type="text" id="exUnit">
                            </div>
                            <div class="form-group">
                                <label>Noter</label>
                                <input type="text" id="exNotes">
                            </div>
                        </div>
                        <input type="hidden" id="editingWorkoutId" value="">
                        <button class="btn-add" id="workoutSaveBtn" onclick="saveWorkout()">+ Tilf√∏j √òvelse</button>
                    </div>
                    
                    ${allWorkouts.length === 0 ? '<p style="color: var(--text-dim); margin: 20px 0">Hviledag</p>' : `
                    <ul class="item-list" style="list-style: none; padding: 0;">
                        ${allWorkouts.map((w, i) => {
                            const key = `${state.selectedDay}-${w.name || w.id}`;
                            const isCustom = !!w.id;
                            const editId = w.id || w.name;
                            
                            return `
                            <li style="margin-bottom: 15px; padding: 15px; background: rgba(255, 165, 0, 0.05); border-radius: 12px; border-left: 4px solid var(--secondary);" class="${state.editMode.workouts ? 'draggable' : ''}" ${state.editMode.workouts ? 'draggable="true"' : ''} data-index="${i}" data-type="workout">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        ${state.editMode.workouts ? '<span class="drag-handle" style="margin-right: 10px;">‚ãÆ‚ãÆ</span>' : ''}
                                        <strong style="font-size: 1.1rem;">${w.name}</strong><br>
                                        <span style="color: var(--text-dim); font-size: 0.9rem;">M√•l: ${
                                            (w.type === 'tid' || w.type === 'time') 
                                            ? `${w.sets} s√¶t √ó ${w.value || w.reps || '?'} ${w.unit || 'sek'}`
                                            : `${w.sets} s√¶t √ó ${w.value || w.reps || '?'}${(w.unit || w.kg) ? ` @ ${w.unit || w.kg}kg` : ''}`
                                        }</span>
                                        ${w.notes ? `<br><span style="font-style: italic; color: var(--text-dim); font-size: 0.85rem;">(${w.notes})</span>` : ''}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        ${!state.editMode.workouts ? `
                                            <button class="edit-btn" onclick="showWorkoutHistory('${w.name || w.id}', '${state.selectedDay}')" style="background: rgba(255, 165, 0, 0.2); color: var(--secondary); padding: 8px 12px;">üìä</button>
                                        ` : ''}
                                        ${state.editMode.workouts ? `
                                            <button class="edit-btn" onclick="loadWorkoutToEdit('${editId}', ${isCustom})">Ret</button>
                                            <button class="delete-icon" onclick="confirmDeleteWorkout('${editId}', ${isCustom})">‚úï</button>
                                        ` : ''}
                                    </div>
                                </div>
                            </li>
                            `;
                        }).join('')}
                    </ul>`}
                </div>
            `;
        }

        function renderKostplan() {
            const mealLibrary = state.customMeals.library || [];
            const dayMealIds = state.mealPlan[state.selectedDay] || [];
            const selectedMeals = dayMealIds.map(id => mealLibrary.find(m => m.id === id)).filter(Boolean);
            
            // Calculate total macros for the day
            const totals = selectedMeals.reduce((acc, m) => {
                acc.cal += m.cal || 0;
                acc.protein += m.protein || 0;
                acc.carbs += m.carbs || 0;
                acc.fat += m.fat || 0;
                return acc;
            }, {cal: 0, protein: 0, carbs: 0, fat: 0});
            
            const canAddMore = dayMealIds.length < 10;
            
            return `
                <div class="card">
                    <button class="edit-toggle ${state.editMode.kostplan ? 'active' : ''}" onclick="toggleEditMode('kostplan')">
                        ${state.editMode.kostplan ? '‚úì F√¶rdig' : '‚úèÔ∏è Rediger'}
                    </button>
                    
                    <h2>Kostplan${selectedMeals.length > 0 ? `<span style="font-weight: normal; font-size: 1.5rem;"> - Kcal: ${totals.cal} | P: ${totals.protein}g | K: ${totals.carbs}g | F: ${totals.fat}g</span>` : ''}</h2>
                    ${renderDaySelector()}
                    
                    ${state.editMode.kostplan ? `
                        <div style="margin-bottom: 30px;">
                            ${canAddMore ? `
                                <button class="btn-add" onclick="showMealSelector()">
                                    + Tilf√∏j M√•ltid
                                </button>
                            ` : `
                                <p style="color: var(--primary); text-align: center; padding: 10px; background: rgba(255, 57, 57, 0.1); border-radius: 8px;">
                                    ‚ö†Ô∏è Max 10 m√•ltider per dag
                                </p>
                            `}
                        </div>
                    ` : ''}
                    
                    ${selectedMeals.length === 0 ? `
                        <p style="color: var(--text-dim); text-align: center; padding: 40px 20px">
                            üçΩÔ∏è Ingen m√•ltider i planen endnu
                        </p>
                    ` : `
                        <ul class="item-list">
                            ${selectedMeals.map((m, i) => `
                                <li class="item">
                                    <div style="flex: 1">
                                        <strong>${m.name}</strong><br>
                                        <span style="color: var(--text-dim); font-size: 0.9rem">${m.desc}</span>
                                        ${m.cal ? `<br><span style="color: var(--secondary); font-size: 0.85rem">${m.cal} kcal | P: ${m.protein || 0}g | K: ${m.carbs || 0}g | F: ${m.fat || 0}g</span>` : ''}
                                    </div>
                                    ${state.editMode.kostplan ? `
                                        <button class="delete-icon" onclick="removeMealFromPlan(${i})">‚úï</button>
                                    ` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    `}
                </div>
            `;
        }

        function showMealSelector() {
            const mealLibrary = state.customMeals.library || [];
            
            if (mealLibrary.length === 0) {
                alert('Du har ingen m√•ltider endnu. G√• til M√•ltider fanen for at oprette nogle!');
                return;
            }
            
            // Filter out meals that are already added to this day
            const dayMealIds = state.mealPlan[state.selectedDay] || [];
            const availableMeals = mealLibrary.filter(meal => !dayMealIds.includes(meal.id));
            
            if (availableMeals.length === 0) {
                alert('Alle dine m√•ltider er allerede tilf√∏jet til denne dag!');
                return;
            }
            
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,15,15,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px" onclick="this.remove()">
                    <div class="card" style="max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2 style="margin-bottom: 20px;">V√¶lg M√•ltid</h2>
                        <ul class="item-list">
                            ${availableMeals.map((m, i) => `
                                <li class="item" style="cursor: pointer;" onclick="addMealToPlan(${m.id}); this.closest('[style*=fixed]').remove();">
                                    <div style="flex: 1">
                                        <strong>${m.name}</strong><br>
                                        <span style="color: var(--text-dim); font-size: 0.9rem">${m.desc}</span>
                                        ${m.cal ? `<br><span style="color: var(--secondary); font-size: 0.85rem">${m.cal} kcal | P: ${m.protein || 0}g | K: ${m.carbs || 0}g | F: ${m.fat || 0}g</span>` : ''}
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                        <button class="btn-add" onclick="this.closest('[style*=fixed]').remove()" style="margin-top: 20px; background: var(--border); color: var(--text);">
                            Annuller
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function addMealToPlan(mealId) {
            if (!state.mealPlan[state.selectedDay]) {
                state.mealPlan[state.selectedDay] = [];
            }
            
            if (state.mealPlan[state.selectedDay].length >= 10) {
                alert('Max 10 m√•ltider per dag!');
                return;
            }
            
            state.mealPlan[state.selectedDay].push(mealId);
            
            // Shopping list is now manual - no automatic sync
            // updateShoppingFromKostplan();
            
            save();
            render();
        }

        function removeMealFromPlan(index) {
            if (!state.mealPlan[state.selectedDay]) return;
            
            state.mealPlan[state.selectedDay].splice(index, 1);
            
            // Shopping list is now manual - no automatic sync
            // updateShoppingFromKostplan();
            
            save();
            render();
        }

        function updateShoppingFromKostplan() {
            // Clear all meal-based ingredients from shopping
            Object.keys(state.shopping).forEach(item => {
                delete state.shopping[item];
            });
            
            // Add ingredients from all meals in kostplan (all days)
            const mealLibrary = state.customMeals.library || [];
            const allMealIds = new Set();
            
            DAYS.forEach(day => {
                if (state.mealPlan[day]) {
                    state.mealPlan[day].forEach(mealId => {
                        allMealIds.add(mealId);
                    });
                }
            });
            
            // For each unique meal in the plan, add its ingredients
            allMealIds.forEach(mealId => {
                const meal = mealLibrary.find(m => m.id === mealId);
                if (meal && meal.ingredients) {
                    meal.ingredients.forEach(ing => {
                        if (ing.item) {
                            if (!state.shopping[ing.item]) {
                                state.shopping[ing.item] = {
                                    inventory: 0,
                                    unit: ing.unit || ''
                                };
                            }
                        }
                    });
                }
            });
        }

        function renderDagligvarer() {
            return `
                <div class="card">
                    <button class="edit-toggle ${state.editMode.household ? 'active' : ''}" onclick="toggleEditMode('household')">
                        ${state.editMode.household ? '‚úì F√¶rdig' : '‚úèÔ∏è Rediger'}
                    </button>
                    
                    <h2>Dagligvarer</h2>
                    
                    <div class="add-form ${state.editMode.household ? '' : 'hidden'}" style="margin-bottom: 30px;">
                        <h3 id="householdFormTitle">Tilf√∏j Dagligvare</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Navn</label>
                                <input type="text" id="householdName">
                            </div>
                            <div class="form-group">
                                <label>Antal</label>
                                <input type="number" step="1" id="householdQuantity">
                            </div>
                            <div class="form-group">
                                <label>Enhed</label>
                                <input type="text" id="householdUnit" list="unitSuggestions">
                                <datalist id="unitSuggestions">
                                    <option value="stk">
                                    <option value="g">
                                    <option value="kg">
                                    <option value="ml">
                                    <option value="l">
                                    <option value="dl">
                                    <option value="spsk">
                                    <option value="tsk">
                                    <option value="pakke">
                                    <option value="d√•se">
                                    <option value="ruller">
                                    <option value="tube">
                                    <option value="flaske">
                                </datalist>
                            </div>
                        </div>
                        <input type="hidden" id="editingHouseholdIndex" value="">
                        <button class="btn-add" id="householdSaveBtn" onclick="saveHouseholdItem()">+ Tilf√∏j Vare</button>
                    </div>
                    
                    ${state.householdItems.length === 0 ? `
                        <p style="color: var(--text-dim); text-align: center; padding: 40px 20px">
                            üß¥ Ingen dagligvarer endnu<br>
                            <span style="font-size: 0.9rem">Klik Rediger for at tilf√∏je</span>
                        </p>
                    ` : `
                        <ul class="item-list">
                            ${state.householdItems.map((item, i) => {
                                const key = `household-${item.name}`;
                                return `<li class="item">
                                    <div style="flex: 1">
                                        <strong>${item.name}</strong>
                                        ${item.quantity || item.unit ? `<br><span style="color: var(--text-dim); font-size: 0.9rem">${item.quantity || ''} ${item.unit || ''}</span>` : ''}
                                    </div>
                                    ${state.editMode.household ? `
                                        <div style="display: flex; align-items: center; gap: 10px">
                                            <button class="edit-btn" onclick="editHouseholdItem(${i})">Ret</button>
                                            <button class="delete-icon" onclick="deleteHouseholdItem(${i})">‚úï</button>
                                        </div>
                                    ` : ''}
                                </li>`;
                            }).join('')}
                        </ul>
                    `}
                </div>
            `;
        }

        function saveHouseholdItem() {
            const name = document.getElementById('householdName').value.trim();
            const quantity = document.getElementById('householdQuantity').value.trim();
            const unit = document.getElementById('householdUnit').value.trim();
            const editingIndex = document.getElementById('editingHouseholdIndex').value;
            
            if (!name) {
                alert('Indtast venligst et navn');
                return;
            }
            
            if (!state.householdItems) state.householdItems = [];
            
            if (editingIndex !== '') {
                // Update existing
                state.householdItems[parseInt(editingIndex)] = {name, quantity, unit};
            } else {
                // Add new
                state.householdItems.push({name, quantity, unit});
            }
            
            // Add to shopping state if not already there
            if (!state.shopping[name]) {
                state.shopping[name] = {
                    inventory: 0,
                    unit: unit || ''
                };
            }
            
            // Reset form
            document.getElementById('householdName').value = '';
            document.getElementById('householdQuantity').value = '';
            document.getElementById('householdUnit').value = '';
            document.getElementById('editingHouseholdIndex').value = '';
            document.getElementById('householdFormTitle').textContent = 'Tilf√∏j Dagligvare';
            document.getElementById('householdSaveBtn').textContent = '+ Tilf√∏j Vare';
            
            save();
            render();
        }

        function editHouseholdItem(index) {
            const item = state.householdItems[index];
            document.getElementById('householdName').value = item.name;
            document.getElementById('householdQuantity').value = item.quantity || '';
            document.getElementById('householdUnit').value = item.unit || '';
            document.getElementById('editingHouseholdIndex').value = index;
            document.getElementById('householdFormTitle').textContent = '‚úèÔ∏è Ret Dagligvare';
            document.getElementById('householdSaveBtn').textContent = '‚úì Gem √Ündringer';
            document.querySelector('.add-form').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function deleteHouseholdItem(index) {
            if (confirm('Er du sikker p√• at du vil slette denne vare?')) {
                state.householdItems.splice(index, 1);
                save();
                render();
            }
        }

        function renderIndk√∏b() {
            // Aggregate all ingredients from all meals across all days
            const aggregatedItems = {};
            
            // Get ingredients from mealPlan (NEW SYSTEM)
            const mealLibrary = state.customMeals.library || [];
            
            DAYS.forEach(day => {
                // Get meal IDs for this day from mealPlan
                const dayMealIds = state.mealPlan[day] || [];
                
                // For each meal ID, find the meal in library and add its ingredients
                dayMealIds.forEach(mealId => {
                    const meal = mealLibrary.find(m => m.id === mealId);
                    
                    if (meal && meal.ingredients) {
                        meal.ingredients.forEach(ing => {
                            if (ing.item) {
                                if (!aggregatedItems[ing.item]) {
                                    aggregatedItems[ing.item] = {
                                        quantity: 0,
                                        unit: ing.unit || '',
                                        checked: state.shopping[ing.item]?.checked || false,
                                        inventory: state.shopping[ing.item]?.inventory || 0,
                                        type: 'ingredient'
                                    };
                                }
                                
                                // Add quantities (try to parse as number, otherwise keep as string)
                                const qty = parseFloat(ing.quantity);
                                if (!isNaN(qty)) {
                                    aggregatedItems[ing.item].quantity += qty;
                                } else {
                                    // If not a number, just append
                                    aggregatedItems[ing.item].quantity = ing.quantity;
                                }
                                
                                // Use the first unit we encounter
                                if (!aggregatedItems[ing.item].unit && ing.unit) {
                                    aggregatedItems[ing.item].unit = ing.unit;
                                }
                            }
                        });
                    }
                });
            });
            
            // Add household items
            if (state.householdItems && state.householdItems.length > 0) {
                state.householdItems.forEach(item => {
                    // Parse quantity as number if available
                    let qty = null;
                    if (item.quantity) {
                        const parsedQty = parseFloat(item.quantity);
                        if (!isNaN(parsedQty)) {
                            qty = parsedQty;
                        }
                    }
                    
                    aggregatedItems[item.name] = {
                        quantity: qty,
                        unit: item.unit || '',
                        checked: state.shopping[item.name]?.checked || false,
                        inventory: state.shopping[item.name]?.inventory || 0,
                        type: 'household'
                    };
                });
            }
            
            // Get items in custom order, or alphabetical if no custom order
            let itemKeys = Object.keys(aggregatedItems);
            
            // Apply custom order if exists
            if (state.shoppingOrder && state.shoppingOrder.length > 0) {
                // Sort by custom order, new items go to end
                itemKeys.sort((a, b) => {
                    const indexA = state.shoppingOrder.indexOf(a);
                    const indexB = state.shoppingOrder.indexOf(b);
                    if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });
            } else {
                itemKeys.sort();
            }
            
            const totalIngredients = itemKeys.filter(k => aggregatedItems[k].type === 'ingredient').length;
            const totalHousehold = itemKeys.filter(k => aggregatedItems[k].type === 'household').length;
            
            return `
                <div class="card">
                    <h2 style="display: flex; align-items: center; gap: 8px;">
                        Indk√∏bsliste
                        <div onclick="showCleanShoppingList()" style="display: inline-flex; align-items: center; justify-content: center; padding: 2px 5px 3px 5px; background: rgba(255, 57, 57, 0.1); border: 2px solid var(--primary); border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255, 57, 57, 0.2)'; this.style.borderColor='var(--secondary)'" onmouseout="this.style.background='rgba(255, 57, 57, 0.1)'; this.style.borderColor='var(--primary)'">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="9" cy="21" r="1"></circle>
                                <circle cx="20" cy="21" r="1"></circle>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                            </svg>
                        </div>
                    </h2>
                    
                    <button class="edit-toggle ${state.editMode.shopping ? 'active' : ''}" onclick="toggleEditMode('shopping')" style="margin-bottom: 20px;">
                        ${state.editMode.shopping ? '‚úì F√¶rdig' : '‚úèÔ∏è Rediger'}
                    </button>
                    
                    ${itemKeys.length === 0 ? `
                        <p style="color: var(--text-dim); text-align: center; padding: 40px 20px">
                            üìù Ingen varer endnu<br>
                            <span style="font-size: 0.9rem">Tilf√∏j m√•ltider i Kostplan eller varer i Dagligvarer</span>
                        </p>
                    ` : `
                        <div>
                            <!-- Column Headers -->
                            <div style="display: grid; grid-template-columns: auto 2fr 0.8fr 0.8fr 0.8fr; gap: 10px; padding: 10px 15px; margin-bottom: 10px; font-weight: 600; color: var(--text-dim); font-size: 0.85rem; border-bottom: 2px solid var(--border);">
                                ${state.editMode.shopping ? '<span style="visibility: hidden;">‚ãÆ‚ãÆ</span>' : '<span style="width: 0"></span>'}
                                <div>Vare</div>
                                <div style="text-align: center;">Ejer</div>
                                <div style="text-align: center;">K√∏b</div>
                                <div style="text-align: center;">Enhed</div>
                            </div>
                            
                            ${itemKeys.map((item, i) => {
                                const data = aggregatedItems[item];
                                const needed = typeof data.quantity === 'number' ? Math.round(data.quantity - (data.inventory || 0)) : (data.inventory > 0 ? data.inventory : '-');
                                const displayNeeded = typeof needed === 'number' ? needed : needed;
                                const displayQty = typeof data.quantity === 'number' ? 
                                    (data.quantity % 1 === 0 ? data.quantity : data.quantity.toFixed(1)) : 
                                    data.quantity;
                                
                                return `
                                    <div class="shopping-item ${state.editMode.shopping ? 'draggable' : ''}" ${state.editMode.shopping ? 'draggable="true"' : ''} data-index="${i}" data-type="shopping" data-item="${item}" style="grid-template-columns: auto 2fr 0.8fr 0.8fr 0.8fr;">
                                        ${state.editMode.shopping ? '<span class="drag-handle">‚ãÆ‚ãÆ</span>' : '<span style="width: 0"></span>'}
                                        <div class="ingredient-name">
                                            ${item}
                                            ${data.type === 'household' ? '<span style="color: var(--secondary); font-size: 0.8rem; margin-left: 5px">üß¥</span>' : ''}
                                        </div>
                                        ${state.editMode.shopping ? `
                                            <input type="number" step="1" value="${Math.round(data.inventory || 0)}" 
                                                  onchange="updateInventory('${item}', this.value)" 
                                                  onmousedown="event.stopPropagation()"
                                                  onclick="event.stopPropagation(); this.select();"
                                                  onfocus="this.select()"
                                                  style="width: 60px; padding: 5px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); text-align: center; margin: 0 auto;"
                                                  placeholder="0">
                                        ` : `<div class="quantity" style="text-align: center;">${data.inventory > 0 ? Math.round(data.inventory) : '-'}</div>`}
                                        <div class="quantity" style="text-align: center; font-weight: ${(typeof needed === 'number' && needed > 0) || (typeof needed === 'string' && needed !== '-' && data.inventory > 0) ? '700' : 'normal'}; color: ${(typeof needed === 'number' && needed > 0) || (typeof needed === 'string' && needed !== '-' && data.inventory > 0) ? 'var(--primary)' : 'var(--text-dim)'}">
                                            ${displayNeeded}
                                        </div>
                                        <div class="quantity" style="text-align: center;">${data.unit || '-'}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${state.editMode.shopping ? `
                            <p style="color: var(--text-dim); margin-top: 20px; font-size: 0.85rem; font-style: italic;">
                                üí° Ejer: Hvad du har hjemme ‚Ä¢ K√∏b: Hvad du skal k√∏be
                            </p>
                        ` : ''}
                    `}
                </div>
            `;
        }

        function updateInventory(item, value) {
            if (!state.shopping[item]) {
                state.shopping[item] = {checked: false, inventory: 0};
            }
            state.shopping[item].inventory = Math.round(parseFloat(value) || 0);
            // Don't save or render - only update state
            // Saving happens when user clicks "F√¶rdig" in toggleEditMode
        }

        function showCleanShoppingList() {
            // Aggregate all items (same logic as renderIndk√∏b)
            const aggregatedItems = {};
            
            // Get ingredients from mealPlan (NEW SYSTEM)
            const mealLibrary = state.customMeals.library || [];
            
            DAYS.forEach(day => {
                // Get meal IDs for this day from mealPlan
                const dayMealIds = state.mealPlan[day] || [];
                
                // For each meal ID, find the meal in library and add its ingredients
                dayMealIds.forEach(mealId => {
                    const meal = mealLibrary.find(m => m.id === mealId);
                    
                    if (meal && meal.ingredients) {
                        meal.ingredients.forEach(ing => {
                            if (ing.item) {
                                if (!aggregatedItems[ing.item]) {
                                    aggregatedItems[ing.item] = {
                                        quantity: 0,
                                        unit: ing.unit || '',
                                        checked: state.modalShopping[ing.item]?.checked || false,
                                        inventory: state.shopping[ing.item]?.inventory || 0,
                                        type: 'ingredient'
                                    };
                                }
                                
                                const qty = parseFloat(ing.quantity);
                                if (!isNaN(qty)) {
                                    aggregatedItems[ing.item].quantity += qty;
                                } else {
                                    aggregatedItems[ing.item].quantity = ing.quantity;
                                }
                                
                                if (!aggregatedItems[ing.item].unit && ing.unit) {
                                    aggregatedItems[ing.item].unit = ing.unit;
                                }
                            }
                        });
                    }
                });
            });
            
            // Add household items
            if (state.householdItems && state.householdItems.length > 0) {
                state.householdItems.forEach(item => {
                    // Parse quantity as number if available
                    let qty = null;
                    if (item.quantity) {
                        const parsedQty = parseFloat(item.quantity);
                        if (!isNaN(parsedQty)) {
                            qty = parsedQty;
                        }
                    }
                    
                    aggregatedItems[item.name] = {
                        quantity: qty,
                        unit: item.unit || '',
                        checked: state.modalShopping[item.name]?.checked || false,
                        inventory: state.shopping[item.name]?.inventory || 0,
                        type: 'household'
                    };
                });
            }
            
            // Get items in custom order
            let itemKeys = Object.keys(aggregatedItems);
            
            // Filter out items where needed amount is 0 or less
            itemKeys = itemKeys.filter(item => {
                const data = aggregatedItems[item];
                const needed = typeof data.quantity === 'number' 
                    ? Math.round(data.quantity - (data.inventory || 0))
                    : (data.inventory > 0 ? Math.round(data.inventory) : 0);
                return typeof needed === 'number' ? needed > 0 : false;
            });
            
            if (state.shoppingOrder && state.shoppingOrder.length > 0) {
                itemKeys.sort((a, b) => {
                    const indexA = state.shoppingOrder.indexOf(a);
                    const indexB = state.shoppingOrder.indexOf(b);
                    if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });
            } else {
                itemKeys.sort();
            }
            
            // Check if there are any items to buy
            if (itemKeys.length === 0) {
                alert('Ingen varer at k√∏be! Alt er fyldt op.');
                return;
            }
            
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,15,15,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px" onclick="closeShoppingModal()">
                    <div class="card" style="max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px;">
                            <h2 style="margin: 0;">üõí Indk√∏bsliste</h2>
                            <button class="delete-btn" onclick="closeShoppingModal()">‚úï</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            ${itemKeys.map((item, i) => {
                                const data = aggregatedItems[item];
                                // For ingredients: needed = quantity - inventory
                                // For household: needed = inventory (what you need to buy)
                                const needed = typeof data.quantity === 'number' 
                                    ? Math.round(data.quantity - (data.inventory || 0))
                                    : (data.inventory > 0 ? Math.round(data.inventory) : '-');
                                
                                return `
                                    <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: center; padding: 15px; margin-bottom: 10px; background: ${data.checked ? 'rgba(0, 255, 136, 0.1)' : 'rgba(255, 165, 0, 0.05)'}; border-radius: 12px; border-left: 4px solid ${data.checked ? 'var(--success)' : 'var(--secondary)'}; ${data.checked ? 'opacity: 0.6;' : ''}">
                                        <div>
                                            <strong style="font-size: 1.1rem; ${data.checked ? 'text-decoration: line-through;' : ''}">${item}</strong>
                                            ${data.type === 'household' ? '<span style="color: var(--secondary); font-size: 0.9rem; margin-left: 8px;">üß¥</span>' : ''}
                                        </div>
                                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary); text-align: right;">
                                            ${needed !== '-' ? needed : ''} ${data.unit || ''}
                                        </div>
                                        <div class="checkbox ${data.checked ? 'checked' : ''}" onclick="toggleShoppingFromModal('${item}', this)" style="width: 30px; height: 30px;"></div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="text-align: center; padding-top: 15px; border-top: 2px solid var(--border);">
                            <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 15px;">
                                ${itemKeys.filter(k => aggregatedItems[k].checked).length} / ${itemKeys.length} afkrydset
                            </p>
                            <button onclick="completeShopping()" style="background: var(--success); color: var(--text); border: none; padding: 12px 30px; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer;">
                                ‚úì K√∏b
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function completeShopping() {
            // Transfer checked items' quantities to inventory
            Object.keys(state.modalShopping).forEach(itemName => {
                if (state.modalShopping[itemName].checked) {
                    // Find the item in aggregated list to get its needed quantity
                    let neededQty = 0;
                    
                    // Check ingredients
                    DAYS.forEach(day => {
                        if (state.customMeals[day]) {
                            state.customMeals[day].forEach(meal => {
                                if (meal.ingredients) {
                                    meal.ingredients.forEach(ing => {
                                        if (ing.item === itemName) {
                                            const qty = parseFloat(ing.quantity);
                                            if (!isNaN(qty)) {
                                                neededQty = qty;
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });
                    
                    // Check household items
                    if (state.householdItems) {
                        const householdItem = state.householdItems.find(h => h.name === itemName);
                        if (householdItem && householdItem.quantity) {
                            const qty = parseFloat(householdItem.quantity);
                            if (!isNaN(qty)) {
                                neededQty = qty;
                            }
                        }
                    }
                    
                    // Calculate what was actually bought (needed - old inventory)
                    const oldInventory = state.shopping[itemName]?.inventory || 0;
                    const bought = Math.max(0, neededQty - oldInventory);
                    
                    // Add to inventory
                    if (!state.shopping[itemName]) {
                        state.shopping[itemName] = {inventory: 0};
                    }
                    state.shopping[itemName].inventory = Math.round(oldInventory + bought);
                }
            });
            
            // Clear all modal checkboxes
            state.modalShopping = {};
            
            save();
            render();
            
            // Close modal
            document.querySelector('[style*="position: fixed"]').remove();
        }

        function toggleShoppingFromModal(item, checkboxElement) {
            // Toggle in modalShopping state only
            if (!state.modalShopping[item]) {
                state.modalShopping[item] = {checked: false};
            }
            state.modalShopping[item].checked = !state.modalShopping[item].checked;
            // Don't save here - only save when clicking "K√∏b"
            
            // Update the modal item visually
            const itemDiv = checkboxElement.closest('[style*="grid-template-columns"]');
            const data = state.modalShopping[item];
            if (data && data.checked) {
                itemDiv.style.background = 'rgba(0, 255, 136, 0.1)';
                itemDiv.style.borderLeftColor = 'var(--success)';
                itemDiv.style.opacity = '0.6';
                itemDiv.querySelector('strong').style.textDecoration = 'line-through';
                checkboxElement.classList.add('checked');
            } else {
                itemDiv.style.background = 'rgba(255, 165, 0, 0.05)';
                itemDiv.style.borderLeftColor = 'var(--secondary)';
                itemDiv.style.opacity = '1';
                itemDiv.querySelector('strong').style.textDecoration = 'none';
                checkboxElement.classList.remove('checked');
            }
            // Update counter
            const modal = checkboxElement.closest('.card');
            const totalChecked = Object.values(state.modalShopping).filter(s => s.checked).length;
            
            // Count total items in modal
            const allItems = modal.querySelectorAll('[style*="grid-template-columns"]').length;
            modal.querySelector('p').textContent = `${totalChecked} / ${allItems} afkrydset`;
        }

        function completeShopping() {
            // For each checked item, add the "k√∏b" amount to inventory
            Object.keys(state.modalShopping).forEach(itemName => {
                if (state.modalShopping[itemName].checked) {
                    // Find the item in aggregated list
                    let purchaseAmount = 0;
                    
                    // Check ingredients
                    DAYS.forEach(day => {
                        if (state.customMeals[day]) {
                            state.customMeals[day].forEach(meal => {
                                if (meal.ingredients) {
                                    meal.ingredients.forEach(ing => {
                                        if (ing.item === itemName) {
                                            const qty = parseFloat(ing.quantity);
                                            if (!isNaN(qty)) {
                                                purchaseAmount += qty;
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });
                    
                    // Check household items
                    if (state.householdItems) {
                        state.householdItems.forEach(item => {
                            if (item.name === itemName && item.quantity) {
                                const qty = parseFloat(item.quantity);
                                if (!isNaN(qty)) {
                                    purchaseAmount = qty;
                                }
                            }
                        });
                    }
                    
                    // Calculate how much to buy (total - current inventory)
                    const currentInventory = state.shopping[itemName]?.inventory || 0;
                    const toBuy = Math.round(purchaseAmount - currentInventory);
                    
                    // Add purchased amount to inventory
                    if (toBuy > 0) {
                        if (!state.shopping[itemName]) {
                            state.shopping[itemName] = {inventory: 0};
                        }
                        state.shopping[itemName].inventory = Math.round(purchaseAmount);
                    }
                }
            });
            
            // Reset all modal checkboxes
            state.modalShopping = {};
            
            save();
            
            // Close modal and refresh
            document.querySelector('[style*="position: fixed"]').remove();
            render();
        }

        function closeShoppingModal() {
            // Reset all modal checkboxes
            state.modalShopping = {};
            save();
            
            // Close modal
            document.querySelector('[style*="position: fixed"]').remove();
        }

        function renderDaySelector() {
            return `<div class="day-selector">
                ${DAYS.map(d => `<button class="day-btn ${state.selectedDay === d ? 'active' : ''}" onclick="setDay('${d}')">${d}</button>`).join('')}
            </div>`;
        }

        // Actions
        function setTab(tab) {
            state.activeTab = tab;
            render();
        }

        function setDay(day) {
            state.selectedDay = day;
            render();
        }

        function toggleMeal(name) {
            const key = `${state.selectedDay}-${name}`;
            state.meals[key] = !state.meals[key];
            save();
            render();
        }

        function toggleWorkout(name) {
            // Open logging modal instead of simple toggle
            openWorkoutLogModal(name, state.selectedDay);
        }
        
        function toggleWorkoutExpand(key) {
            if (!state.expandedWorkouts) state.expandedWorkouts = {};
            state.expandedWorkouts[key] = !state.expandedWorkouts[key];
            render();
        }
        
        function logWorkoutFromInline(workoutName, key, numSets, workoutType) {
            // Collect data from all sets
            const today = new Date().toISOString().split('T')[0];
            
            if (!state.workoutLog) state.workoutLog = [];
            
            let loggedCount = 0;
            for (let i = 0; i < numSets; i++) {
                const valueInput = document.getElementById(`log_${key}_value_${i}`);
                const unitInput = document.getElementById(`log_${key}_unit_${i}`);
                const noteInput = document.getElementById(`log_${key}_note_${i}`);
                
                const value = valueInput ? valueInput.value : '';
                const unit = unitInput ? unitInput.value : '';
                const note = noteInput ? noteInput.value : '';
                
                if (value) { // Only log if value is filled
                    state.workoutLog.push({
                        date: today,
                        day: state.selectedDay,
                        workoutId: workoutName,
                        name: workoutName,
                        set: i + 1,
                        value: value,
                        type: workoutType || 'reps',
                        unit: unit || '',
                        notes: note || ''
                    });
                    loggedCount++;
                }
            }
            
            if (loggedCount > 0) {
                console.log(`‚úÖ Logged ${loggedCount} sets for ${workoutName}`);
                
                // Collapse the workout
                state.expandedWorkouts[key] = false;
                
                // Save and render
                save();
                render();
            } else {
                alert('Udfyld mindst 1 s√¶t');
            }
        }
        
        function deleteWorkoutLogToday(workoutName, day) {
            const today = new Date().toISOString().split('T')[0];
            
            if (confirm(`Slet dagens tr√¶ning for ${workoutName}?`)) {
                // Remove all logs for this workout, day, and today
                state.workoutLog = (state.workoutLog || []).filter(log => 
                    !(log.name === workoutName && log.day === day && log.date === today)
                );
                
                save();
                render();
            }
        }
        
        function openWorkoutLogModal(nameOrId, day) {
            // Find the workout
            const allWorkouts = [...(WORKOUTS[day] || []), ...(state.customWorkouts[day] || [])];
            const workout = allWorkouts.find(w => (w.name || w.id) == nameOrId);
            
            if (!workout) return;
            
            // Parse number of sets
            const numSets = parseInt(workout.sets) || 3;
            
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,15,15,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px" onclick="closeWorkoutLogModal()">
                    <div class="card" style="max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px;">
                            <h2 style="margin: 0;">üí™ ${workout.name}</h2>
                            <button class="delete-btn" onclick="closeWorkoutLogModal()">‚úï</button>
                        </div>
                        
                        <p style="color: var(--text-dim); margin-bottom: 20px; font-size: 0.95rem;">
                            <strong>M√•l:</strong> ${workout.sets} s√¶t √ó ${workout.reps}${workout.kg ? ` @ ${workout.kg}kg` : ''}
                            ${workout.notes ? `<br><em>${workout.notes}</em>` : ''}
                        </p>
                        
                        <div id="setLogRows" style="margin-bottom: 20px;">
                            ${Array.from({length: numSets}, (_, i) => `
                                <div style="display: grid; grid-template-columns: 50px 1fr 1fr 2fr; gap: 12px; align-items: center; padding: 15px; margin-bottom: 12px; background: rgba(255, 165, 0, 0.05); border-radius: 12px; border-left: 4px solid var(--secondary);">
                                    <strong style="color: var(--secondary); font-size: 1.3rem; text-align: center;">S√¶t ${i + 1}</strong>
                                    <div>
                                        <label style="display: block; color: var(--text-dim); font-size: 0.85rem; margin-bottom: 5px;">Reps</label>
                                        <input type="number" id="setReps${i}" value="${workout.reps.split('-')[0] || workout.reps}" placeholder="${workout.reps}" style="width: 100%; padding: 10px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1.1rem; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; color: var(--text-dim); font-size: 0.85rem; margin-bottom: 5px;">Kg</label>
                                        <input type="number" step="0.5" id="setKg${i}" value="${workout.kg || ''}" placeholder="${workout.kg || '0'}" style="width: 100%; padding: 10px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1.1rem; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; color: var(--text-dim); font-size: 0.85rem; margin-bottom: 5px;">Note</label>
                                        <input type="text" id="setNote${i}" placeholder="God form, tr√¶t..." style="width: 100%; padding: 10px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.95rem;">
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button class="btn-add" onclick="saveWorkoutLog('${workout.name || workout.id}', '${day}', ${numSets})" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                            ‚úì Log Tr√¶ning
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function closeWorkoutLogModal() {
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
        }
        
        function saveWorkoutLog(workoutName, day, numSets) {
            // Collect data from all sets
            const today = new Date().toISOString().split('T')[0];
            
            if (!state.workoutLog) state.workoutLog = [];
            
            for (let i = 0; i < numSets; i++) {
                const repsInput = document.getElementById(`setReps${i}`);
                const kgInput = document.getElementById(`setKg${i}`);
                const noteInput = document.getElementById(`setNote${i}`);
                
                const reps = repsInput ? repsInput.value : '';
                const kg = kgInput ? kgInput.value : '';
                const note = noteInput ? noteInput.value : '';
                
                if (reps) { // Only log if reps is filled
                    state.workoutLog.push({
                        date: today,
                        day: day,
                        workoutId: workoutName,
                        name: workoutName,
                        set: i + 1,  // Changed from setNumber to set
                        reps: reps,
                        kg: kg || '',
                        notes: note || ''
                    });
                }
            }
            
            console.log(`‚úÖ Logged ${numSets} sets for ${workoutName}`);
            
            // Close modal
            closeWorkoutLogModal();
            
            // Save and render
            save();
            render();
        }

        function logWorkout(workoutId) {
            // This function is now deprecated - keeping for compatibility
            console.warn('logWorkout is deprecated - use openWorkoutLogModal instead');
        }

        function showWorkoutHistory(nameOrId, day) {
            // Find workout to get name
            const allWorkouts = [...(WORKOUTS[day] || []), ...(state.customWorkouts[day] || [])];
            const workout = allWorkouts.find(w => (w.name || w.id) == nameOrId);
            
            if (!workout) return;
            
            // Filter logs for this exercise on this day
            const logs = (state.workoutLog || []).filter(log => 
                log.name === workout.name && log.day === day
            );
            
            if (logs.length === 0) {
                alert('Ingen log endnu for denne √∏velse');
                return;
            }
            
            // Group logs by workout+date combination
            const groupedLogs = {};
            logs.forEach(log => {
                const groupKey = `${log.name}-${log.date}`;
                if (!groupedLogs[groupKey]) {
                    groupedLogs[groupKey] = {
                        workoutName: log.name,
                        date: log.date,
                        sets: []
                    };
                }
                groupedLogs[groupKey].sets.push(log);
            });
            
            // Sort groups by date (newest first)
            const sortedGroups = Object.values(groupedLogs).sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,15,15,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px" onclick="this.remove()">
                    <div class="card" style="max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px;">
                            <h2 style="margin: 0;">üìä ${workout.name}</h2>
                            <button class="delete-btn" onclick="this.closest('[style*=fixed]').remove()">‚úï</button>
                        </div>
                        
                        <p style="color: var(--text-dim); margin-bottom: 20px;">Progressionslog for ${day}</p>
                        
                        <div style="margin-bottom: 20px;">
                            ${sortedGroups.map((group, groupIdx) => {
                                const sortedSets = group.sets.sort((a, b) => a.set - b.set);
                                // Calculate volume only for reps type workouts
                                const totalVolume = sortedSets.reduce((sum, log) => {
                                    const logType = log.type || 'reps';
                                    if (logType === 'reps') {
                                        const unit = log.unit || log.kg;
                                        const value = log.value || log.reps;
                                        const vol = unit && value ? parseFloat(unit) * parseFloat(value) : 0;
                                        return sum + vol;
                                    }
                                    return sum;
                                }, 0);
                                
                                return `
                                <div style="margin-bottom: 10px;">
                                    <div onclick="toggleHistoryGroup('group_${groupIdx}')" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255, 165, 0, 0.1); border-radius: 8px; cursor: pointer; border-left: 3px solid var(--secondary); transition: all 0.2s;">
                                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                            <span id="arrow_group_${groupIdx}" style="font-size: 1rem; transition: transform 0.3s;">‚ñº</span>
                                            <div style="flex: 1;">
                                                <strong style="color: var(--primary); font-size: 1.1rem;">${group.date}</strong>
                                            </div>
                                            <span style="color: var(--text-dim); font-size: 0.85rem;">${sortedSets.length} s√¶t${totalVolume > 0 ? ` ‚Ä¢ ${totalVolume.toFixed(0)}kg vol` : ''}</span>
                                        </div>
                                        <button class="delete-icon" onclick="event.stopPropagation(); deleteWorkoutSession('${group.date}', '${group.workoutName}', '${day}')" style="margin-left: 10px;">‚úï</button>
                                    </div>
                                    
                                    <div id="group_${groupIdx}" style="display: none; margin-top: 6px; padding: 8px 0 0 30px;">
                                        ${sortedSets.map(log => {
                                            const logType = log.type || 'reps';
                                            const valueLabel = logType === 'tid' ? 'TID' : 'REPS';
                                            const unitLabel = logType === 'tid' ? 'ENHED' : 'KG';
                                            
                                            // Backward compatibility
                                            const value = log.value || log.reps || '-';
                                            const unit = log.unit || log.kg || '-';
                                            
                                            // Calculate volume only for reps type
                                            const showVolume = logType === 'reps' && value !== '-' && unit !== '-';
                                            const volume = showVolume ? (parseFloat(unit) * parseFloat(value)).toFixed(0) : null;
                                            
                                            return `
                                            <div style="display: grid; grid-template-columns: 70px 70px 70px 70px 1fr; gap: 10px; align-items: center; padding: 12px; margin-bottom: 5px; background: rgba(0, 0, 0, 0.3); border-radius: 6px; font-size: 0.9rem;">
                                                <div>
                                                    <span style="color: var(--text-dim); font-size: 0.75rem;">S√ÜT</span><br>
                                                    <strong style="color: var(--secondary); font-size: 1.2rem;">${log.set || '?'}</strong>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-dim); font-size: 0.75rem;">${valueLabel}</span><br>
                                                    <strong style="font-size: 1.1rem;">${value}</strong>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-dim); font-size: 0.75rem;">${unitLabel}</span><br>
                                                    <strong style="color: var(--success); font-size: 1.1rem;">${unit}</strong>
                                                </div>
                                                ${showVolume ? `
                                                    <div>
                                                        <span style="color: var(--text-dim); font-size: 0.75rem;">VOL</span><br>
                                                        <strong style="color: var(--primary); font-size: 1.1rem;">${volume}</strong>
                                                    </div>
                                                ` : '<div></div>'}
                                                ${log.notes ? `
                                                    <div style="grid-column: span 5; margin-top: 5px;">
                                                        <span style="color: var(--text-dim); font-size: 0.75rem;">NOTE</span><br>
                                                        <em style="color: var(--text-dim); font-size: 0.9rem;">${log.notes}</em>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `}).join('')}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                        
                        <div style="text-align: center; padding-top: 15px; border-top: 2px solid var(--border);">
                            <p style="color: var(--text-dim); font-size: 0.9rem;">
                                ${sortedGroups.length} ${sortedGroups.length === 1 ? 'session' : 'sessions'} logget
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function toggleHistoryGroup(groupId) {
            const content = document.getElementById(groupId);
            const arrow = document.getElementById('arrow_' + groupId);
            
            if (content && arrow) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    content.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        }
        
        function deleteWorkoutSession(date, workoutName, day) {
            if (confirm(`Slet alle s√¶t fra ${date}?`)) {
                // Remove all logs for this date, workout, and day
                state.workoutLog = state.workoutLog.filter(log => 
                    !(log.date === date && log.name === workoutName && log.day === day)
                );
                save();
                // Close and reopen modal
                const modal = document.querySelector('[style*="position: fixed"]');
                if (modal) modal.remove();
                render();
            }
        }
        
        function deleteWorkoutLog(index) {
            if (confirm('Slet denne log?')) {
                state.workoutLog.splice(index, 1);
                
                save();
                syncToCloud(); // Force immediate sync to Google Sheets
                
                // Close and reopen modal to refresh
                const modal = document.querySelector('[style*="position: fixed"]');
                if (modal) modal.remove();
                render();
            }
        }

        function toggleShopping(item) {
            // Store checkbox state separately from ingredient data
            if (!state.shopping[item]) {
                state.shopping[item] = {checked: true};
            } else if (typeof state.shopping[item] === 'boolean') {
                state.shopping[item] = {checked: !state.shopping[item]};
            } else {
                state.shopping[item].checked = !state.shopping[item].checked;
            }
            save();
            render();
        }

        function updateWeight() {
            // Only log weight if it has actually changed
            const hasChanged = state.weight !== state.tempWeight;
            
            console.log('=== UPDATE WEIGHT ===');
            console.log('Current weight:', state.weight);
            console.log('Temp weight:', state.tempWeight);
            console.log('Has changed:', hasChanged);
            
            state.weight = state.tempWeight;
            
            if (hasChanged) {
                console.log('Weight changed - adding to history');
                state.weightHistory.push({
                    date: new Date().toISOString().split('T')[0],
                    weight: state.tempWeight
                });
            } else {
                console.log('Weight unchanged - skipping history entry');
            }
            
            save();
            render();
        }

        function adjustWeight(amount) {
            state.tempWeight = Math.max(30, Math.min(300, state.tempWeight + amount));
            state.tempWeight = Math.round(state.tempWeight * 10) / 10;
            render();
        }

        function updateGoals() {
            console.log('=== UPDATE GOALS DEBUG ===');
            const startInput = document.getElementById('startWeightInput');
            const goalInput = document.getElementById('goalWeightInput');
            
            console.log('Start input element:', startInput);
            console.log('Goal input element:', goalInput);
            
            if (!startInput || !goalInput) {
                console.error('Input elements not found!');
                return;
            }
            
            console.log('Start input value:', startInput.value);
            console.log('Goal input value:', goalInput.value);
            console.log('Before - startWeight:', state.startWeight, 'goalWeight:', state.goalWeight);
            
            if (startInput.value) {
                state.startWeight = parseFloat(startInput.value);
            }
            if (goalInput.value) {
                state.goalWeight = parseFloat(goalInput.value);
            }
            
            console.log('After - startWeight:', state.startWeight, 'goalWeight:', state.goalWeight);
            
            save();
            console.log('Saved to localStorage');
            render();
        }

        function saveMeal() {
            const name = document.getElementById('mealName').value;
            const desc = document.getElementById('mealDesc').value;
            const cal = document.getElementById('mealCal').value;
            const protein = document.getElementById('mealProtein').value;
            const carbs = document.getElementById('mealCarbs').value;
            const fat = document.getElementById('mealFat').value;
            const editingIndex = document.getElementById('editingMealId').value;
            
            if (!name || !desc) {
                alert('Udfyld navn og beskrivelse');
                return;
            }

            // Filter out empty ingredient rows
            const ingredients = state.currentIngredients
                .filter(ing => ing.item && ing.quantity)
                .map(ing => ({
                    item: ing.item.trim(), 
                    quantity: ing.quantity.trim(),
                    unit: ing.unit ? ing.unit.trim() : ''
                }));

            const mealData = {
                name,
                desc,
                cal: cal ? parseInt(cal) : null,
                protein: protein ? parseInt(protein) : null,
                carbs: carbs ? parseInt(carbs) : null,
                fat: fat ? parseInt(fat) : null,
                ingredients
            };

            // Initialize library if it doesn't exist
            if (!state.customMeals.library) state.customMeals.library = [];

            if (editingIndex !== '') {
                // Editing existing meal
                const idx = parseInt(editingIndex);
                if (idx >= 0 && idx < state.customMeals.library.length) {
                    const oldMeal = state.customMeals.library[idx];
                    
                    // Update the meal but keep the same ID
                    state.customMeals.library[idx] = {
                        id: oldMeal.id,
                        ...mealData
                    };
                    
                    // Clean up old ingredients from shopping list
                    if (oldMeal.ingredients) {
                        removeIngredientsFromShopping(oldMeal.ingredients);
                    }
                }
            } else {
                // Adding new meal
                state.customMeals.library.push({ 
                    id: Date.now(), 
                    ...mealData 
                });
            }

            // Shopping list is now manual - no automatic sync
            // updateShoppingFromKostplan();

            // Reset form
            document.getElementById('mealName').value = '';
            document.getElementById('mealDesc').value = '';
            document.getElementById('mealCal').value = '';
            document.getElementById('mealProtein').value = '';
            document.getElementById('mealCarbs').value = '';
            document.getElementById('mealFat').value = '';
            document.getElementById('editingMealId').value = '';
            document.getElementById('mealFormTitle').textContent = '+ Tilf√∏j M√•ltid';
            document.getElementById('mealSaveBtn').textContent = '+ Tilf√∏j M√•ltid';
            
            state.currentIngredients = [{item: '', quantity: '', unit: ''}];
            renderIngredientRows();

            save();
            render();
        }

        function removeIngredientsFromShopping(ingredients) {
            if (!ingredients || ingredients.length === 0) return;
            
            ingredients.forEach(oldIng => {
                // Check if any other meal uses this ingredient
                let stillUsed = false;
                
                // Check all days and all meals
                DAYS.forEach(day => {
                    if (state.customMeals[day]) {
                        state.customMeals[day].forEach(meal => {
                            if (meal.ingredients) {
                                if (meal.ingredients.some(ing => ing.item === oldIng.item)) {
                                    stillUsed = true;
                                }
                            }
                        });
                    }
                });
                
                // Only remove if not used by any other meals
                if (!stillUsed) {
                    delete state.shopping[oldIng.item];
                }
            });
        }

        function confirmDeleteMeal(index) {
            if (confirm('Er du sikker p√• at du vil slette dette m√•ltid?')) {
                const mealLibrary = state.customMeals.library || [];
                
                if (index >= 0 && index < mealLibrary.length) {
                    const meal = mealLibrary[index];
                    const mealId = meal.id;
                    
                    // Remove meal from library
                    state.customMeals.library.splice(index, 1);
                    
                    // Remove meal from all days in meal plan
                    DAYS.forEach(day => {
                        if (state.mealPlan[day]) {
                            state.mealPlan[day] = state.mealPlan[day].filter(id => id !== mealId);
                        }
                    });
                    
                    // Shopping list is now manual - no automatic sync
                    // updateShoppingFromKostplan();
                }
                
                save();
                render();
            }
        }

        function loadMealToEdit(index) {
            const mealLibrary = state.customMeals.library || [];
            
            if (index < 0 || index >= mealLibrary.length) {
                console.error('Invalid meal index:', index);
                return;
            }
            
            const meal = mealLibrary[index];
            if (!meal) return;

            document.getElementById('mealName').value = meal.name;
            document.getElementById('mealDesc').value = meal.desc;
            document.getElementById('mealCal').value = meal.cal || '';
            document.getElementById('mealProtein').value = meal.protein || '';
            document.getElementById('mealCarbs').value = meal.carbs || '';
            document.getElementById('mealFat').value = meal.fat || '';
            document.getElementById('editingMealId').value = index;
            document.getElementById('mealFormTitle').textContent = '‚úèÔ∏è Ret M√•ltid';
            document.getElementById('mealSaveBtn').textContent = '‚úì Gem √Ündringer';
            
        // Load ingredients
        if (meal.ingredients && meal.ingredients.length > 0) {
            state.currentIngredients = meal.ingredients.map(ing => ({...ing}));
            // Add empty row at the end for adding more ingredients
            state.currentIngredients.push({item: '', quantity: '', unit: ''});
        } else {
            state.currentIngredients = [{item: '', quantity: '', unit: ''}];
        }
            
            renderIngredientRows();
            document.querySelector('.add-form').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function deleteWeightEntry(dateToDelete) {
            if (confirm('Er du sikker p√• at du vil slette denne v√¶gtm√•ling?')) {
                console.log('=== DELETE WEIGHT ENTRY DEBUG ===');
                console.log('Date to delete:', dateToDelete);
                console.log('Before delete - weightHistory:', JSON.stringify(state.weightHistory));
                
                // Filter out the specific date
                const beforeLength = state.weightHistory.length;
                const newHistory = [];
                
                state.weightHistory.forEach(entry => {
                    console.log(`Comparing: "${entry.date}" === "${dateToDelete}" ?`, entry.date === dateToDelete);
                    if (entry.date !== dateToDelete) {
                        newHistory.push(entry);
                    } else {
                        console.log('DELETING:', entry);
                    }
                });
                
                state.weightHistory = newHistory;
                
                console.log('After delete - weightHistory:', JSON.stringify(state.weightHistory));
                console.log('Deleted entries:', beforeLength - state.weightHistory.length);
                
                // Force save to localStorage immediately
                localStorage.setItem('fitnessData', JSON.stringify(state));
                console.log('Saved to localStorage');
                
                // Check if there's still data
                if (state.weightHistory.length === 0) {
                    const modal = document.querySelector('[style*="position: fixed"]');
                    if (modal) modal.remove();
                    alert('Alle v√¶gtm√•linger slettet');
                    render();
                    return;
                }
                
                // Close and reopen modal with fresh data
                const modal = document.querySelector('[style*="position: fixed"]');
                if (modal) modal.remove();
                
                setTimeout(() => {
                    showWeightGraph();
                }, 100);
            }
        }

        function deleteWeightEntryByIndex(index) {
            // Gem scroll position F√òR confirm dialog
            const scrollContainer = document.getElementById('graphScrollContainer');
            const savedScrollPosition = scrollContainer ? scrollContainer.scrollLeft : 0;
            
            if (confirm('Er du sikker p√• at du vil slette denne v√¶gtm√•ling?')) {
                console.log('=== DELETE BY INDEX DEBUG ===');
                console.log('Deleting index:', index);
                console.log('Before delete:', state.weightHistory.length, 'entries');
                console.log('Entry to delete:', state.weightHistory[index]);
                console.log('Saved scroll position:', savedScrollPosition);
                
                // Remove by index
                state.weightHistory.splice(index, 1);
                
                console.log('After delete:', state.weightHistory.length, 'entries');
                
                // Save to localStorage and sync
                save();
                
                // Check if there's still data
                if (state.weightHistory.length === 0) {
                    const modal = document.querySelector('[style*="position: fixed"][style*="z-index: 9999"]');
                    if (modal) modal.remove();
                    alert('Alle v√¶gtm√•linger slettet');
                    render();
                    return;
                }
                
                // Close and reopen modal with fresh data
                const modal = document.querySelector('[style*="position: fixed"][style*="z-index: 9999"]');
                if (modal) modal.remove();
                
                // Reopen graph and restore scroll position
                setTimeout(() => {
                    showWeightGraph();
                    
                    // Restore scroll position efter graph er rendered
                    setTimeout(() => {
                        const newScrollContainer = document.getElementById('graphScrollContainer');
                        if (newScrollContainer) {
                            newScrollContainer.scrollLeft = savedScrollPosition;
                            console.log('Restored scroll position to:', savedScrollPosition);
                        }
                    }, 50);
                }, 50);
            }
            // Hvis annuller: g√∏r ingenting, modalen forbliver √•ben
        }

        function saveWorkout() {
            const name = document.getElementById('exName').value;
            const sets = document.getElementById('exSets').value;
            const type = document.getElementById('exType').value;
            const value = document.getElementById('exValue').value;
            const unit = document.getElementById('exUnit').value;
            const notes = document.getElementById('exNotes').value;
            const editingId = document.getElementById('editingWorkoutId').value;

            if (!name || !sets || !value) {
                alert('Udfyld √∏velse, s√¶t og antal/tid');
                return;
            }

            if (editingId) {
                // Check if it's a custom workout (has numeric id)
                const isCustom = !isNaN(editingId);
                
                if (isCustom) {
                    // Editing existing custom workout
                    const idx = state.customWorkouts[state.selectedDay]?.findIndex(w => w.id == editingId);
                    
                    if (idx >= 0) {
                        state.customWorkouts[state.selectedDay][idx] = {
                            id: state.customWorkouts[state.selectedDay][idx].id,
                            name,
                            sets,
                            value,
                            type,
                            unit: unit || '',
                            notes
                        };
                    }
                } else {
                    // Editing a default workout - convert to custom
                    if (!state.customWorkouts[state.selectedDay]) state.customWorkouts[state.selectedDay] = [];
                    
                    // Check if we already converted this one
                    const existingIdx = state.customWorkouts[state.selectedDay].findIndex(w => w.originalName === editingId);
                    
                    if (existingIdx >= 0) {
                        // Update existing converted workout
                        state.customWorkouts[state.selectedDay][existingIdx] = {
                            id: state.customWorkouts[state.selectedDay][existingIdx].id,
                            originalName: editingId,
                            name,
                            sets,
                            value,
                            type,
                            unit: unit || '',
                            notes
                        };
                    } else {
                        // Create new converted workout and mark the original as hidden
                        state.customWorkouts[state.selectedDay].push({ 
                            id: Date.now(), 
                            originalName: editingId,
                            name, 
                            sets, 
                            value,
                            type,
                            unit: unit || '',
                            notes 
                        });
                    }
                }
            } else {
                // Adding new workout
                if (!state.customWorkouts[state.selectedDay]) state.customWorkouts[state.selectedDay] = [];
                state.customWorkouts[state.selectedDay].push({ 
                    id: Date.now(), 
                    name, 
                    sets, 
                    value, 
                    type,
                    unit: unit || '', 
                    notes 
                });
            }

            // Reset form
            document.getElementById('exName').value = '';
            document.getElementById('exSets').value = '';
            document.getElementById('exType').value = 'reps';
            document.getElementById('exValue').value = '';
            document.getElementById('exUnit').value = '';
            document.getElementById('exNotes').value = '';
            document.getElementById('editingWorkoutId').value = '';
            document.getElementById('workoutFormTitle').textContent = '+ Tilf√∏j √òvelse';
            document.getElementById('workoutSaveBtn').textContent = '+ Tilf√∏j √òvelse';
            updateWorkoutTypeFields(); // Reset field labels

            save();
            render();
        }

        function updateWorkoutTypeFields() {
            const type = document.getElementById('exType').value;
            const valueLabel = document.getElementById('valueLabel');
            const unitLabel = document.getElementById('unitLabel');
            const valueInput = document.getElementById('exValue');
            const unitField = document.getElementById('unitField');
            
            if (type === 'reps') {
                valueLabel.textContent = 'Reps';
                unitLabel.textContent = 'Kg';
                valueInput.placeholder = '';
                
                // Replace with input field for kg
                unitField.innerHTML = `
                    <label id="unitLabel">Kg</label>
                    <input type="text" id="exUnit">
                `;
            } else if (type === 'tid') {
                valueLabel.textContent = 'Tid';
                unitLabel.textContent = 'Enhed';
                valueInput.placeholder = '';
                
                // Replace with dropdown for time unit
                unitField.innerHTML = `
                    <label id="unitLabel">Enhed</label>
                    <select id="exUnit">
                        <option value="sek">Sekunder</option>
                        <option value="min">Minutter</option>
                        <option value="timer">Timer</option>
                    </select>
                `;
            }
        }

        function loadWorkoutToEdit(editId, isCustom) {
            console.log('üîß loadWorkoutToEdit called:', {editId, isCustom, day: state.selectedDay});
            
            const allWorkouts = [...(WORKOUTS[state.selectedDay] || []), ...(state.customWorkouts[state.selectedDay] || [])];
            console.log('üìã All workouts:', allWorkouts);
            
            let workout;
            if (isCustom) {
                // It's a custom workout - find by ID
                workout = allWorkouts.find(w => w.id == editId);
                console.log('üîç Looking for custom workout with ID:', editId, 'Found:', workout);
            } else {
                // It's a default workout - find by name
                workout = allWorkouts.find(w => w.name == editId);
                console.log('üîç Looking for default workout with name:', editId, 'Found:', workout);
            }
            
            if (!workout) {
                console.error('‚ùå Workout not found!');
                alert('Kunne ikke finde √∏velsen!');
                return;
            }
            
            document.getElementById('exName').value = workout.name;
            document.getElementById('exSets').value = workout.sets;
            document.getElementById('exType').value = workout.type || 'reps';
            
            // Update fields first (this recreates the unit input/select)
            updateWorkoutTypeFields();
            
            // Backward compatibility: if workout has old 'reps' field, use it as 'value'
            const value = workout.value || workout.reps || '';
            const unit = workout.unit || workout.kg || '';
            
            // Then set the values
            document.getElementById('exValue').value = value;
            document.getElementById('exUnit').value = unit;
            document.getElementById('exNotes').value = workout.notes || '';
            document.getElementById('editingWorkoutId').value = editId;
            document.getElementById('workoutFormTitle').textContent = '‚úèÔ∏è Ret √òvelse';
            document.getElementById('workoutSaveBtn').textContent = '‚úì Gem √Ündringer';
            
            console.log('‚úÖ Form loaded with values');
            document.querySelector('.add-form').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function confirmDeleteWorkout(id, isCustom) {
            if (confirm('Er du sikker p√• at du vil slette denne √∏velse?')) {
                if (isCustom) {
                    state.customWorkouts[state.selectedDay] = state.customWorkouts[state.selectedDay].filter(w => w.id != id);
                }
                save();
                render();
            }
        }

        function editMeal(nameOrId, isCustom) {
            const allMeals = [...(MEALS[state.selectedDay] || []), ...(state.customMeals[state.selectedDay] || [])];
            const meal = allMeals.find(m => (m.name || m.id) == nameOrId);
            if (!meal) return;

            const newName = prompt('M√•ltid navn:', meal.name);
            const newDesc = prompt('Beskrivelse:', meal.desc);
            
            if (newName && newDesc) {
                if (isCustom) {
                    const idx = state.customMeals[state.selectedDay].findIndex(m => m.id == nameOrId);
                    if (idx >= 0) {
                        state.customMeals[state.selectedDay][idx] = {
                            ...state.customMeals[state.selectedDay][idx],
                            name: newName,
                            desc: newDesc
                        };
                    }
                } else {
                    // Convert to custom meal
                    if (!state.customMeals[state.selectedDay]) state.customMeals[state.selectedDay] = [];
                    state.customMeals[state.selectedDay].push({
                        id: Date.now(),
                        name: newName,
                        desc: newDesc
                    });
                    // Remove from default by marking it completed to hide
                }
                save();
                render();
            }
        }

        function editWorkout(nameOrId, isCustom) {
            const allWorkouts = [...(WORKOUTS[state.selectedDay] || []), ...(state.customWorkouts[state.selectedDay] || [])];
            const workout = allWorkouts.find(w => (w.name || w.id) == nameOrId);
            if (!workout) return;

            const newName = prompt('√òvelse navn:', workout.name);
            const newSets = prompt('S√¶t:', workout.sets);
            const newReps = prompt('Reps/Tid:', workout.reps);
            const newNotes = prompt('Noter (valgfri):', workout.notes || '');
            
            if (newName && newSets && newReps) {
                if (isCustom) {
                    const idx = state.customWorkouts[state.selectedDay].findIndex(w => w.id == nameOrId);
                    if (idx >= 0) {
                        state.customWorkouts[state.selectedDay][idx] = {
                            ...state.customWorkouts[state.selectedDay][idx],
                            name: newName,
                            sets: newSets,
                            reps: newReps,
                            notes: newNotes
                        };
                    }
                } else {
                    // Convert to custom workout
                    if (!state.customWorkouts[state.selectedDay]) state.customWorkouts[state.selectedDay] = [];
                    state.customWorkouts[state.selectedDay].push({
                        id: Date.now(),
                        name: newName,
                        sets: newSets,
                        reps: newReps,
                        notes: newNotes
                    });
                }
                save();
                render();
            }
        }

        function toggleEditMode(section) {
            if (section === 'stats') {
                if (state.editMode.stats) {
                    // Exiting edit mode - save weight and goals BEFORE toggling
                    // Read values while inputs still exist
                    const startInput = document.getElementById('startWeightInput');
                    const goalInput = document.getElementById('goalWeightInput');
                    
                    console.log('=== TOGGLE EDIT MODE (stats) ===');
                    console.log('Exiting edit mode, saving values...');
                    console.log('Start input:', startInput ? startInput.value : 'NOT FOUND');
                    console.log('Goal input:', goalInput ? goalInput.value : 'NOT FOUND');
                    
                    // Update goals from inputs
                    if (startInput && startInput.value) {
                        state.startWeight = parseFloat(startInput.value);
                        console.log('Updated startWeight to:', state.startWeight);
                    }
                    if (goalInput && goalInput.value) {
                        state.goalWeight = parseFloat(goalInput.value);
                        console.log('Updated goalWeight to:', state.goalWeight);
                    }
                    
                    // Update current weight
                    updateWeight();
                    
                    // Save to localStorage
                    save();
                }
                state.editMode.stats = !state.editMode.stats;
                state.tempWeight = state.weight; // Reset temp weight to current
            } else if (section === 'meals') {
                // Reset meal form when exiting edit mode
                if (state.editMode.meals) {
                    document.getElementById('mealName').value = '';
                    document.getElementById('mealDesc').value = '';
                    document.getElementById('mealCal').value = '';
                    document.getElementById('mealProtein').value = '';
                    document.getElementById('mealCarbs').value = '';
                    document.getElementById('mealFat').value = '';
                    document.getElementById('editingMealId').value = '';
                    document.getElementById('mealFormTitle').textContent = '+ Tilf√∏j M√•ltid';
                    document.getElementById('mealSaveBtn').textContent = '+ Tilf√∏j M√•ltid';
                    state.currentIngredients = [{item: '', quantity: '', unit: ''}];
                }
                state.editMode[section] = !state.editMode[section];
            } else if (section === 'shopping') {
                // Save when exiting shopping edit mode
                if (state.editMode.shopping) {
                    console.log('üíæ Saving shopping data...');
                    save();
                }
                state.editMode[section] = !state.editMode[section];
            } else {
                state.editMode[section] = !state.editMode[section];
            }
            render();
        }

        function showWeightGraph() {
            const history = state.weightHistory; // Show ALL data
            if (history.length === 0) {
                alert('Ingen v√¶gtdata endnu');
                return;
            }

            // Scale from goalWeight-5 to startWeight+5 for better zoom on relevant range
            const maxWeight = state.startWeight + 5;
            const minWeight = state.goalWeight - 5;
            const range = maxWeight - minWeight;
            
            
            
            // Calculate width: 80px per point on desktop, fyld container p√• mobil
            const isMobile = window.innerWidth <= 768;
            const leftMargin = 10;
            const rightMargin = 10;
            
            let pointSpacing, svgWidth;
            
            
            if (isMobile) {
                // P√• mobil: brug t√¶ttere fast spacing, lad grafen v√¶re bred nok
                pointSpacing = 50; // T√¶ttere punkter p√• mobil
                const calculatedWidth = leftMargin + ((history.length - 1) * pointSpacing) + rightMargin;
                svgWidth = Math.max(400, calculatedWidth); // Minimum 400px bred
            } else {
                // P√• desktop: brug fast spacing og scroll
                pointSpacing = 80;
                const calculatedWidth = leftMargin + ((history.length - 1) * pointSpacing) + rightMargin;
                svgWidth = Math.max(800, calculatedWidth);
            }
            
            // Helper function to calculate Y position (inverted, with padding)
            const getY = (weight) => {
                return 10 + ((maxWeight - weight) / range) * 80; // 10% padding, proper inversion
            };
            
            // Helper for X position - start ved leftMargin
            const getX = (index) => {
                return leftMargin + (index * pointSpacing);
            };
            
            // Format date as DD-MMM-YYYY
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
                return `${date.getDate()}-${months[date.getMonth()]}-${date.getFullYear()}`;
            };

            const graphHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,15,15,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px" onclick="this.remove()">
                    <div class="card" style="max-width: 1000px; width: 100%; max-height: 90vh; overflow-y: auto" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px">
                            <h2 style="margin: 0">V√¶gtprogression</h2>
                            <button class="delete-btn" onclick="this.closest('[style*=fixed]').remove()">Luk</button>
                        </div>
                        
                        <!-- Graph container with sticky Y-axis -->
                        <div style="background: var(--bg-dark); border-radius: 12px; border: 2px solid var(--border); position: relative; display: flex;">
                            <!-- Sticky Y-axis (left side) -->
                            <div style="width: 80px; flex-shrink: 0; padding: 40px 0 140px 0; position: sticky; left: 0; background: var(--bg-dark); z-index: 10;">
                                <svg width="80" height="400" viewBox="0 0 80 400" style="display: block;">
                                    <!-- Y-axis labels aligned with graph -->
                                    ${[maxWeight, state.startWeight, state.goalWeight, minWeight].map(weight => {
                                        const yPercent = getY(weight);
                                        const y = yPercent * 4; // Scale to viewBox
                                        const isGoal = weight === state.goalWeight;
                                        const isStart = weight === state.startWeight;
                                        return `
                                            <text 
                                                x="65" y="${y}" 
                                                fill="${isGoal ? 'var(--success)' : isStart ? 'var(--secondary)' : 'var(--text-dim)'}" 
                                                font-size="16" 
                                                text-anchor="end" 
                                                dominant-baseline="middle"
                                                style="font-family: 'DM Sans', sans-serif; font-weight: 600;"
                                            >${weight}kg</text>
                                        `;
                                    }).join('')}
                                </svg>
                            </div>
                            
                            <!-- Scrollable graph area with custom scrollbar -->
                            <div id="graphScrollContainer" style="flex: 1; overflow-x: auto; overflow-y: hidden; padding: 40px 20px 0px 0;">
                                <style>
                                    #graphScrollContainer::-webkit-scrollbar {
                                        height: 8px;
                                    }
                                    #graphScrollContainer::-webkit-scrollbar-track {
                                        background: rgba(255, 255, 255, 0.05);
                                        border-radius: 10px;
                                    }
                                    #graphScrollContainer::-webkit-scrollbar-thumb {
                                        background: rgba(200, 200, 200, 0.3);
                                        border-radius: 10px;
                                    }
                                    #graphScrollContainer::-webkit-scrollbar-thumb:hover {
                                        background: rgba(200, 200, 200, 0.5);
                                    }
                                </style>
                                <svg width="${svgWidth}" height="500" viewBox="0 0 ${svgWidth} 500" style="display: block;">
                                    <!-- Grid lines (horizontal) - ONLY for goalWeight and min/max -->
                                    ${[maxWeight, state.goalWeight, minWeight].map(weight => {
                                        const yPercent = getY(weight);
                                        const y = yPercent * 4;
                                        const isGoal = weight === state.goalWeight;
                                        return `
                                            <line 
                                                x1="0" y1="${y}" 
                                                x2="${svgWidth}" y2="${y}" 
                                                stroke="${isGoal ? 'var(--success)' : 'rgba(255,255,255,0.1)'}" 
                                                stroke-width="1" 
                                                ${isGoal ? 'stroke-dasharray="8,8"' : ''}
                                            />
                                        `;
                                    }).join('')}
                                    
                                    <!-- Main line -->
                                    <polyline 
                                        points="${history.map((h, i) => {
                                            const x = getX(i);
                                            const yPercent = getY(h.weight);
                                            const y = yPercent * 4;
                                            return `${x},${y}`;
                                        }).join(' ')}" 
                                        fill="none" 
                                        stroke="var(--primary)" 
                                        stroke-width="3"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                    
                                    <!-- Data points with hover tooltips -->
                                    ${history.map((h, i) => {
                                        const x = getX(i);
                                        const yPercent = getY(h.weight);
                                        const y = yPercent * 4;
                                        
                                        // Smart tooltip positioning
                                        const isFirst = i === 0;
                                        const isLast = i === history.length - 1;
                                        
                                        let rectX, textX;
                                        if (isFirst) {
                                            // F√∏rste punkt: rect starter ved punktet
                                            rectX = x;
                                            textX = x + 70; // Center of rect: x + (140/2)
                                        } else if (isLast) {
                                            // Sidste punkt: rect ender ved punktet
                                            rectX = x - 140;
                                            textX = x - 70; // Center of rect: (x-140) + (140/2)
                                        } else {
                                            // Midter punkter: rect centreret
                                            rectX = x - 70;
                                            textX = x; // Center of rect
                                        }
                                        
                                        return `
                                            <g class="data-point-group">
                                                <circle 
                                                    cx="${x}" cy="${y}" 
                                                    r="4" 
                                                    fill="var(--primary)" 
                                                    stroke="var(--bg-dark)"
                                                    stroke-width="1.5"
                                                    style="cursor: pointer; transition: all 0.2s;"
                                                    onmouseover="this.setAttribute('r', '7'); this.nextElementSibling.style.display='block';"
                                                    onmouseout="this.setAttribute('r', '4'); this.nextElementSibling.style.display='none';"
                                                />
                                                <g style="display: none; pointer-events: none;">
                                                    <!-- Tooltip background -->
                                                    <rect 
                                                        x="${rectX}" 
                                                        y="${y - 45}" 
                                                        width="140" 
                                                        height="35" 
                                                        fill="rgba(20, 20, 20, 0.95)" 
                                                        stroke="var(--primary)"
                                                        stroke-width="1.5"
                                                        rx="6"
                                                    />
                                                    <!-- Tooltip date (centreret i boksen) -->
                                                    <text 
                                                        x="${textX}" 
                                                        y="${y - 30}" 
                                                        fill="var(--text-dim)" 
                                                        font-size="11" 
                                                        text-anchor="middle"
                                                        style="font-family: 'DM Sans', sans-serif;"
                                                    >${formatDate(h.date)}</text>
                                                    <!-- Tooltip weight (centreret i boksen) -->
                                                    <text 
                                                        x="${textX}" 
                                                        y="${y - 15}" 
                                                        fill="var(--primary)" 
                                                        font-size="16" 
                                                        font-weight="700"
                                                        text-anchor="middle"
                                                        style="font-family: 'DM Sans', sans-serif;"
                                                    >${h.weight} kg</text>
                                                </g>
                                            </g>
                                        `;
                                    }).join('')}
                                    
                                    <!-- X-axis delete buttons ABOVE date labels -->
                                    ${history.map((h, i) => {
                                        const x = getX(i);
                                        // Delete button at y=380
                                        const deleteY = 380;
                                        
                                        // Calculate dateX based on pattern from first 3
                                        // Pattern: dateX = x - 70 for proper alignment
                                        const dateX = x - 70;
                                        
                                        return `
                                            <g>
                                                <!-- Delete button (first, at graph bottom) -->
                                                <g style="cursor: pointer;" onclick="event.stopPropagation(); deleteWeightEntryByIndex(${i});">
                                                    <circle 
                                                        cx="${x}" cy="${deleteY}" 
                                                        r="9" 
                                                        fill="rgba(255, 57, 57, 0.2)" 
                                                        stroke="var(--primary)"
                                                        stroke-width="1.5"
                                                        style="transition: all 0.2s;"
                                                        onmouseover="this.setAttribute('fill', 'var(--primary)');"
                                                        onmouseout="this.setAttribute('fill', 'rgba(255, 57, 57, 0.2)');"
                                                    />
                                                    <text 
                                                        x="${x}" y="${deleteY}" 
                                                        fill="white" 
                                                        font-size="13" 
                                                        font-weight="700"
                                                        text-anchor="middle"
                                                        dominant-baseline="middle"
                                                        style="font-family: 'DM Sans', sans-serif; pointer-events: none;"
                                                    >‚úï</text>
                                                </g>
                                                
                                                <!-- Date label (below delete button, rotated -90¬∞) -->
                                                <text 
                                                    x="${dateX}" y="424" 
                                                    fill="var(--text-dim)" 
                                                    font-size="14" 
                                                    text-anchor="start"
                                                    transform="rotate(-90 ${x} 420)"
                                                    style="font-family: 'DM Sans', sans-serif;"
                                                >${formatDate(h.date)}</text>
                                            </g>
                                        `;
                                    }).join('')}
                                </svg>
                            </div>
                        </div>

                        <div style="margin-top: 20px">
                            <div class="stat-grid">
                                <div class="stat-box">
                                    <div class="value">${state.startWeight.toFixed(1)} <span style="font-size: 1.5rem">kg</span></div>
                                    <div class="label">START</div>
                                </div>
                                <div class="stat-box">
                                    <div class="value">${history[history.length-1].weight} <span style="font-size: 1.5rem">kg</span></div>
                                    <div class="label">SENESTE</div>
                                </div>
                                <div class="stat-box">
                                    <div class="value">${(state.startWeight - history[history.length-1].weight).toFixed(1)} <span style="font-size: 1.5rem">kg</span></div>
                                    <div class="label">√ÜNDRING</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', graphHTML);
            
            // Auto-scroll to show newest data (rightmost)
            setTimeout(() => {
                const scrollContainer = document.getElementById('graphScrollContainer');
                if (scrollContainer && history.length > 10) {
                    scrollContainer.scrollLeft = scrollContainer.scrollWidth;
                }
            }, 50);
        }

        // Load from cloud (which will call render when done)
        // But render immediately with localStorage first for fast startup
        
        // Render immediately with localStorage data
        console.log('üöÄ Fast startup: Rendering from localStorage');
        checkDailyReset();
        render();
        
        // Then load from Google Sheets in background and update
        loadFromCloud();
        
        // Fallback: If not in Apps Script, we're already rendered above
        setTimeout(() => {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                console.log('üì± Not in Apps Script - using localStorage only');
                
                // Hide loading overlay since we won't load from Google Sheets
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => overlay.remove(), 300);
                }
            }
        }, 100);
    </script>

</body>
</html>
